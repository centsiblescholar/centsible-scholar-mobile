---
phase: 04-subscription-ui-gates
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - app/(tabs)/settings.tsx
  - app/manage-subscription.tsx
  - app/student-management.tsx
autonomous: true

must_haves:
  truths:
    - "Settings subscription card shows plan name, status badge (Active green / Inactive red), renewal date, and action buttons"
    - "Manage Subscription button in Settings navigates to in-app manage-subscription screen (not web URL)"
    - "Restore Purchases button in Settings triggers mock restore with loading state and success/failure alert"
    - "Manage Subscription screen shows current plan details with upgrade/downgrade options"
    - "Plan changes on manage screen trigger mock purchase mutation and update subscription record"
    - "Downgrade shows confirmation dialog warning about feature loss"
    - "Student limit is enforced when parent tries to add a student beyond their plan allowance"
    - "Student limit exceeded shows alert with upgrade CTA that navigates to paywall"
    - "No Stripe URLs, no 'manage on website' text, no external payment links anywhere"
    - "Dev-only debug section on manage-subscription screen allows setting subscription to various states"
  artifacts:
    - path: "app/(tabs)/settings.tsx"
      provides: "Overhauled subscription section with plan details, manage button, restore button"
      contains: "manage-subscription"
    - path: "app/manage-subscription.tsx"
      provides: "In-app subscription management with plan switching and debug tools"
      min_lines: 150
    - path: "app/student-management.tsx"
      provides: "Student limit enforcement before add student"
      contains: "getStudentLimit"
  key_links:
    - from: "app/(tabs)/settings.tsx"
      to: "app/manage-subscription.tsx"
      via: "router.push('/manage-subscription')"
      pattern: "manage-subscription"
    - from: "app/(tabs)/settings.tsx"
      to: "src/hooks/useSubscriptionStatus.ts"
      via: "useSubscriptionStatus for subscription display"
      pattern: "useSubscriptionStatus"
    - from: "app/manage-subscription.tsx"
      to: "src/hooks/useMockPurchase.ts"
      via: "useMockPurchase for plan changes"
      pattern: "useMockPurchase"
    - from: "app/manage-subscription.tsx"
      to: "src/constants/subscriptionPlans.ts"
      via: "SUBSCRIPTION_PLANS for plan display"
      pattern: "SUBSCRIPTION_PLANS"
    - from: "app/student-management.tsx"
      to: "src/constants/subscriptionPlans.ts"
      via: "getStudentLimit for limit enforcement"
      pattern: "getStudentLimit"
    - from: "app/student-management.tsx"
      to: "src/hooks/useSubscriptionStatus.ts"
      via: "useSubscriptionStatus for tier"
      pattern: "useSubscriptionStatus"
---

<objective>
Overhaul the Settings subscription section, build the manage-subscription screen, and add student limit enforcement to student management.

Purpose: Complete the subscription management experience -- users can view, manage, restore, and change their subscription entirely in-app, and student limits are enforced by plan tier.
Output: Updated Settings with in-app subscription management, new manage-subscription screen with debug tools, student-management with limit enforcement.
</objective>

<execution_context>
@/Users/robertisrael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertisrael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-subscription-ui-gates/04-CONTEXT.md
@.planning/phases/04-subscription-ui-gates/04-RESEARCH.md
@.planning/phases/04-subscription-ui-gates/04-01-SUMMARY.md
@app/(tabs)/settings.tsx
@app/student-management.tsx
@src/hooks/useSubscriptionStatus.ts
@src/hooks/useStudentManagement.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Overhaul Settings subscription section and add Restore Purchases</name>
  <files>app/(tabs)/settings.tsx</files>
  <action>
Modify the existing Settings screen's Subscription section to replace the web URL link with in-app subscription management.

**Changes to Subscription section:**

1. **Replace `handleManageSubscription`:** Change from `Linking.openURL('https://centsiblescholar.com/settings')` to `router.push('/manage-subscription' as any)`. This addresses Pitfall 5 from research.

2. **Enhance subscription card display:**
   - Add a status badge next to the status text: green badge for Active/Trialing, red badge for Canceled/Inactive. Use a small View with borderRadius, backgroundColor (#10B981 for active, #EF4444 for inactive), and the status text inside.
   - Show plan features count: "X features included" text below plan name (use `SUBSCRIPTION_PLANS.find(p => p.id === tier)?.features.length`)
   - If `isActive` is not true (null or false), change the "Manage Subscription" button text to "Subscribe Now" and navigate to `/paywall` instead of `/manage-subscription`

3. **Add Restore Purchases button:**
   - Add a second button below "Manage Subscription": "Restore Purchases" with Ionicons 'refresh-circle-outline' icon
   - On press: show loading state (ActivityIndicator replacing button text), wait 1.5s mock delay, query `user_subscriptions` for current user with active/trialing status via Supabase
   - If found: Alert.alert("Subscription Restored!", "Your subscription has been restored successfully.") and call refetchSubscription()
   - If not found: Alert.alert("No Purchases Found", "No active subscription was found for this account.")
   - Add local state `isRestoring` to manage loading

4. **Import additions:**
   - Add import of `SUBSCRIPTION_PLANS` from `../../src/constants/subscriptionPlans`
   - Add import of `supabase` from `../../src/integrations/supabase/client` (for restore query)
   - Keep all existing imports

5. **Remove Stripe references:** Remove the `Linking` import usage for subscription management. Keep `Linking` for other uses (help center, contact support, privacy, terms, delete account, notification settings).

6. **Hide subscription section for students:** Wrap the entire Subscription section in `{isParent && (...)}` since students inherit subscription from parents and should not see subscription management.

**Do NOT change** any other sections (Profile, Tutorial, Notifications, App, Support, Account). Only modify the Subscription section and add the restore functionality.
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Grep for 'centsiblescholar.com/settings' in settings.tsx -- should NOT appear. Verify 'manage-subscription' route reference exists.</verify>
  <done>Settings subscription section shows enhanced plan card with status badge, navigates to in-app manage-subscription (not web URL), has Restore Purchases button with mock flow, and is hidden for students.</done>
</task>

<task type="auto">
  <name>Task 2: Create manage-subscription screen and add student limit enforcement</name>
  <files>app/manage-subscription.tsx, app/student-management.tsx</files>
  <action>
**app/manage-subscription.tsx:**

Create the in-app subscription management screen.

**Layout (top to bottom):**
1. Current plan summary card at top:
   - Plan name (large, bold) with status badge (Active green / Trialing blue / Inactive red)
   - Student limit: "X of Y students" (e.g., "2 of 3 students")
   - Renewal date: "Renews [formatted date]" or "Trial ends [date]" if trialing
   - Current billing: "$X.XX/mo" or "$X.XX/yr"

2. "Change Plan" section:
   - Three plan option rows (not full cards -- simpler than paywall):
     - Plan name, price, student limit on each row
     - Current plan has "Current" label, others have "Switch" button
   - Billing toggle (monthly/annual) above the plan options
   - Tapping "Switch" on a different plan:
     - If downgrade (switching to a plan with fewer students): show `Alert.alert` confirmation: "Downgrade to [Plan]?" with body "You'll have a limit of [X] students. If you currently have more, you won't be able to add new students until you're under the limit." Buttons: Cancel / Confirm Downgrade
     - If upgrade: show `Alert.alert` confirmation: "Upgrade to [Plan]?" with body "You'll be able to have up to [X] students." Buttons: Cancel / Confirm Upgrade
     - On confirm: call `useMockPurchase().purchase({ plan, billingInterval })` with loading state
     - On success: Alert "Plan updated!" and refresh subscription data

3. "Cancel Subscription" section:
   - Red text link at bottom: "Cancel Subscription"
   - On press: Alert.alert "Cancel Subscription?" with body "You'll lose access to all features at the end of your current billing period." Buttons: Keep Subscription / Cancel Subscription (destructive)
   - On confirm cancel: update Supabase `user_subscriptions` row setting status to 'canceled', then refetch. Show Alert "Subscription Canceled" with "You'll have access until [period end date]."

4. **Dev-only debug section (only visible when `__DEV__` is true):**
   - Section header: "Debug Tools (Dev Only)"
   - Four buttons in a row/grid:
     - "Set Active" - updates status to 'active'
     - "Set Trialing" - updates status to 'trialing'
     - "Set Canceled" - updates status to 'canceled'
     - "Delete Sub" - deletes the subscription row entirely
   - Each button directly modifies the Supabase row and invalidates the subscription cache
   - Use `subscriptionKeys` from useSubscriptionStatus for cache invalidation

**Imports:**
- `SUBSCRIPTION_PLANS, getStudentLimit, getAnnualSavingsPercent` from `../src/constants/subscriptionPlans`
- `useMockPurchase` from `../src/hooks/useMockPurchase`
- `useSubscriptionStatus, subscriptionKeys` from `../src/hooks/useSubscriptionStatus`
- `useStudentManagement` from `../src/hooks/useStudentManagement` (for active student count display)
- `useAuth` from `../src/contexts/AuthContext`
- `supabase` from `../src/integrations/supabase/client`
- `useQueryClient` from `@tanstack/react-query`

**app/student-management.tsx -- Add student limit enforcement:**

Modify the existing `handleAddStudent` function (around line 84) and the add button press handler to check student limits before allowing student creation.

1. Add imports at top:
   - `import { getStudentLimit } from '../src/constants/subscriptionPlans';`
   - `import { useSubscriptionStatus } from '../src/hooks/useSubscriptionStatus';`
   - `import { router } from 'expo-router';` (already imported)

2. Inside `StudentManagementScreen` component, add:
   ```
   const { tier } = useSubscriptionStatus();
   const studentLimit = getStudentLimit(tier);
   ```

3. At the START of `handleAddStudent` (before existing validation), add limit check:
   ```
   if (studentLimit > 0 && activeStudents.length >= studentLimit) {
     Alert.alert(
       'Student Limit Reached',
       `Your plan allows ${studentLimit} student${studentLimit !== 1 ? 's' : ''}. Upgrade your plan to add more students.`,
       [
         { text: 'Cancel', style: 'cancel' },
         { text: 'Upgrade Plan', onPress: () => router.push('/paywall' as any) },
       ]
     );
     return;
   }
   ```

4. Also add the same check to the "Add Student" button press handler (the `onPress` of the add button in the header, around line 236, and the "Add Student" button in the empty state, around line 264). Before showing the add modal, check the limit:
   ```
   const handleOpenAddModal = () => {
     if (studentLimit > 0 && activeStudents.length >= studentLimit) {
       Alert.alert(
         'Student Limit Reached',
         `Your plan allows ${studentLimit} student${studentLimit !== 1 ? 's' : ''}. Upgrade your plan to add more students.`,
         [
           { text: 'Cancel', style: 'cancel' },
           { text: 'Upgrade Plan', onPress: () => router.push('/paywall' as any) },
         ]
       );
       return;
     }
     resetForm();
     setShowAddModal(true);
   };
   ```
   Replace both inline `onPress` handlers that currently call `resetForm(); setShowAddModal(true);` with `handleOpenAddModal()`.

This is a minimal, surgical addition to the existing student-management.tsx. Do NOT restructure or rewrite existing code -- only add the limit check.
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Verify manage-subscription.tsx exists with plan switching and debug tools. Verify student-management.tsx imports getStudentLimit and checks limit before add.</verify>
  <done>Manage-subscription screen shows current plan, allows switching with confirmation dialogs, has cancel option, and includes dev debug tools. Student management blocks adding students beyond plan limit with upgrade CTA.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `app/(tabs)/settings.tsx` has no 'centsiblescholar.com/settings' reference (Stripe URL removed)
- `app/(tabs)/settings.tsx` navigates to '/manage-subscription' for subscription management
- `app/(tabs)/settings.tsx` has Restore Purchases button with mock flow
- `app/manage-subscription.tsx` exists with plan display, switching, cancel, and __DEV__ debug tools
- `app/student-management.tsx` checks student limit before allowing add
- All three files compile without errors
- No external payment links or Stripe references in any modified file
</verification>

<success_criteria>
- Settings subscription card shows plan name, status badge, renewal date, and correct action buttons
- "Manage Subscription" navigates to in-app screen (not web URL)
- "Restore Purchases" triggers mock flow with loading state and appropriate alert
- Manage-subscription screen displays current plan with upgrade/downgrade/cancel options
- Plan switching shows appropriate confirmation dialog (different messages for upgrade vs downgrade)
- Cancel subscription updates status and shows end-of-period warning
- Dev debug tools (visible only in __DEV__) allow testing Active, Trialing, Canceled, and no-subscription states
- Student limit enforcement blocks add student when at plan limit
- Upgrade CTA from student limit alert navigates to paywall
- Zero Stripe/web URL references remain in subscription-related code
</success_criteria>

<output>
After completion, create `.planning/phases/04-subscription-ui-gates/04-03-SUMMARY.md`
</output>
