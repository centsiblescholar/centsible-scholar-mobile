---
phase: 04-subscription-ui-gates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/constants/subscriptionPlans.ts
  - src/hooks/useSubscriptionGate.ts
  - src/hooks/useMockPurchase.ts
autonomous: true

must_haves:
  truths:
    - "Subscription plan data (names, prices, limits, features) is centralized and consistent"
    - "Subscription gate distinguishes parent (check own sub) from student (check parent's sub via relationship)"
    - "Mock purchase writes a real subscription row to Supabase with trialing status and 7-day trial period"
    - "Mock purchase invalidates subscription cache so gate re-evaluates immediately"
  artifacts:
    - path: "src/constants/subscriptionPlans.ts"
      provides: "Plan definitions, pricing, student limits, feature lists, utility functions"
      exports: ["SUBSCRIPTION_PLANS", "STUDENT_LIMITS", "getStudentLimit", "getAnnualSavings", "getAnnualSavingsPercent", "SubscriptionPlan"]
    - path: "src/hooks/useSubscriptionGate.ts"
      provides: "Combined auth + subscription gate check with student inheritance"
      exports: ["useSubscriptionGate"]
    - path: "src/hooks/useMockPurchase.ts"
      provides: "Mock purchase mutation that writes to user_subscriptions"
      exports: ["useMockPurchase"]
  key_links:
    - from: "src/hooks/useSubscriptionGate.ts"
      to: "src/hooks/useSubscriptionStatus.ts"
      via: "imports and wraps useSubscriptionStatus"
      pattern: "useSubscriptionStatus"
    - from: "src/hooks/useSubscriptionGate.ts"
      to: "parent_student_relationships table"
      via: "Supabase query for student inheritance"
      pattern: "parent_student_relationships"
    - from: "src/hooks/useMockPurchase.ts"
      to: "user_subscriptions table"
      via: "Supabase insert/update for mock purchase"
      pattern: "user_subscriptions"
    - from: "src/hooks/useMockPurchase.ts"
      to: "src/hooks/useSubscriptionStatus.ts"
      via: "invalidateQueries on subscriptionKeys.all"
      pattern: "subscriptionKeys"
---

<objective>
Create the data layer for subscription gating: centralized plan constants, a subscription gate hook that handles both parent and student users (with inheritance), and a mock purchase mutation hook.

Purpose: All three Phase 4 screens (paywall, settings, manage-subscription) need shared plan data and hooks. Building these first enables Plan 02 and Plan 03 to execute in parallel.
Output: Three new files providing the subscription data layer consumed by all downstream plans.
</objective>

<execution_context>
@/Users/robertisrael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertisrael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-subscription-ui-gates/04-CONTEXT.md
@.planning/phases/04-subscription-ui-gates/04-RESEARCH.md
@src/hooks/useSubscriptionStatus.ts
@src/hooks/useStudentManagement.ts
@src/contexts/AuthContext.tsx
@src/integrations/supabase/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create subscription plan constants</name>
  <files>src/constants/subscriptionPlans.ts</files>
  <action>
Create `src/constants/subscriptionPlans.ts` with centralized plan definitions used by paywall, settings, and student limit enforcement.

Include:
- `SubscriptionPlan` interface with fields: id ('single' | 'midsize' | 'large'), name (string), description (string), monthlyPrice (number), annualPrice (number), studentLimit (number), features (string[]), badge (string | undefined)
- `SUBSCRIPTION_PLANS` array with three plans matching web app pricing:
  - Standard (single): $9.99/mo, $99.99/yr, 1 student, features: [One student account, Complete allocation tracking, Daily behavior assessments, Comprehensive grade tracking, Financial literacy education, Email support]
  - Premium (midsize): $12.99/mo, $129.99/yr, 3 students, badge: 'Most Popular', features: [Up to 3 student accounts, Family dashboard view, Individual student dashboards, All Standard features, Advanced analytics & reports, Priority email support]
  - Family (large): $15.99/mo, $159.99/yr, 5 students, features: [Up to 5 student accounts, Everything in Premium, Best per-student value, Advanced family analytics, Priority email support, Early access to new features]
- `STUDENT_LIMITS` record mapping subscription_type to limit: { single: 1, midsize: 3, large: 5 }
- `getStudentLimit(subscriptionType: string | null): number` - returns 0 for null/unknown
- `getAnnualSavings(plan: SubscriptionPlan): number` - returns dollar savings (monthly*12 - annual)
- `getAnnualSavingsPercent(plan: SubscriptionPlan): number` - returns rounded percentage

Follow existing naming conventions (UPPERCASE_SNAKE_CASE for constants, camelCase for functions, PascalCase for interfaces). Use named exports (not default).
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Verify file exports all 6 items listed in artifacts.</verify>
  <done>subscriptionPlans.ts exports SubscriptionPlan, SUBSCRIPTION_PLANS (3 plans), STUDENT_LIMITS, getStudentLimit, getAnnualSavings, getAnnualSavingsPercent with correct pricing data.</done>
</task>

<task type="auto">
  <name>Task 2: Create subscription gate hook and mock purchase hook</name>
  <files>src/hooks/useSubscriptionGate.ts, src/hooks/useMockPurchase.ts</files>
  <action>
**useSubscriptionGate.ts:**
Create a hook that provides the subscription gate decision for the root redirect.

It must handle two scenarios:
1. **Parent user:** Use existing `useSubscriptionStatus` to check their own subscription. Return `{ gateStatus: 'loading' | 'subscribed' | 'not_subscribed' | 'error', error, refetch }`.
2. **Student user:** Look up parent via `parent_student_relationships` table (query by student_user_id, get parent_user_id), then check parent's subscription in `user_subscriptions` table (status IN ['active', 'trialing']). Students inherit access -- never show paywall to students, show an error screen directing them to contact their parent if parent is not subscribed.

Implementation details:
- Import `useAuth` for user and userRole
- Import `useSubscriptionStatus` for parent self-check
- Use `useQuery` with key `['subscriptionGate', 'studentInheritance', userId]` for student inheritance query (staleTime: 5 minutes)
- The hook returns a unified interface regardless of role:
  ```
  {
    gateStatus: 'loading' | 'subscribed' | 'not_subscribed' | 'error',
    isStudent: boolean,  // true if role is student (affects UI -- show "contact parent" instead of paywall)
    error: Error | null,
    refetch: () => void,
  }
  ```
- For parents: map `isActive === true` to 'subscribed', `isActive === null || isActive === false` to 'not_subscribed', `isLoading` to 'loading', `error` to 'error'
- For students: perform the two-step query (find parent, check parent sub). If parent sub is active/trialing -> 'subscribed'. If not -> 'not_subscribed'. Query error -> 'error'.
- If no user or no userRole yet, return 'loading'

**useMockPurchase.ts:**
Create a mock purchase mutation hook using TanStack React Query `useMutation`.

Implementation details:
- Import `useMutation` and `useQueryClient` from TanStack
- Import `supabase` from integrations
- Import `useAuth` for user.id
- Import `subscriptionKeys` from `useSubscriptionStatus` for cache invalidation
- `MockPurchaseInput` interface: `{ plan: 'single' | 'midsize' | 'large', billingInterval: 'month' | 'year' }`
- mutationFn:
  1. Simulate 1.5 second delay with `setTimeout` promise
  2. Calculate `current_period_end` as 7 days from now (trial period)
  3. Use two-step pattern to avoid upsert unique constraint issues (research Pitfall 2):
     - First: query `user_subscriptions` for existing record with user_id
     - If exists: UPDATE that row with new status/plan/dates
     - If not: INSERT new row
  4. Set `status: 'trialing'`, `subscription_type: input.plan`, `platform: 'apple'` (mock as IAP)
  5. Set `current_period_start` to now, `current_period_end` to 7 days from now
- onSuccess: `queryClient.invalidateQueries({ queryKey: subscriptionKeys.all })` to trigger gate re-evaluation
- Return from hook: `{ purchase: mutation.mutateAsync, isPurchasing: mutation.isPending, purchaseError: mutation.error }`

Both hooks follow existing patterns: useQuery with factory keys, named exports, camelCase functions, error logging with console.error.
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Verify both files export their hooks with correct signatures.</verify>
  <done>useSubscriptionGate returns gateStatus for both parent (self-check) and student (inheritance) users. useMockPurchase writes to user_subscriptions with two-step pattern and invalidates subscription cache on success.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `src/constants/subscriptionPlans.ts` exists with 3 plans and correct pricing
- `src/hooks/useSubscriptionGate.ts` exists and handles parent + student roles
- `src/hooks/useMockPurchase.ts` exists with two-step insert/update pattern
- No new dependencies added (all imports from existing packages)
</verification>

<success_criteria>
- Three new files created with correct TypeScript types
- Plan pricing matches web app: 9.99/12.99/15.99 monthly, 99.99/129.99/159.99 annual
- Student limits correct: single=1, midsize=3, large=5
- Gate hook handles both parent and student roles without showing paywall to students
- Mock purchase uses two-step pattern (not upsert) to avoid constraint issues
- Cache invalidation wired so subscription status updates immediately after mock purchase
</success_criteria>

<output>
After completion, create `.planning/phases/04-subscription-ui-gates/04-01-SUMMARY.md`
</output>
