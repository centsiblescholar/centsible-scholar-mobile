---
phase: 04-subscription-ui-gates
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - app/paywall.tsx
  - app/index.tsx
  - app/_layout.tsx
autonomous: true

must_haves:
  truths:
    - "Non-subscribed parent is redirected to paywall on app launch"
    - "Paywall shows three vertically stacked plan cards with correct pricing"
    - "Monthly/annual billing toggle changes displayed prices with annual savings badge"
    - "Premium card has 'Most Popular' badge"
    - "7-day free trial disclosure appears below plan selection, above subscribe button"
    - "Terms of Service and Privacy Policy links appear in footer below subscribe button"
    - "Tapping a plan triggers mock purchase flow with loading spinner and success feedback"
    - "After successful mock purchase, user is redirected to dashboard (gate passes)"
    - "'Already subscribed? Restore Purchases' link appears on paywall"
    - "X button in top-right dismisses paywall modal (user re-gated on next launch)"
    - "Subscribed parent goes straight to dashboard without paywall flash"
    - "Student user never sees paywall (shows 'contact parent' screen if parent unsubscribed)"
    - "Network error on subscription check shows error screen with retry button"
  artifacts:
    - path: "app/paywall.tsx"
      provides: "Paywall screen with plan cards, billing toggle, mock purchase, trial disclosure, legal links"
      min_lines: 200
    - path: "app/index.tsx"
      provides: "Root redirect with subscription gate before dashboard navigation"
      contains: "useSubscriptionGate"
    - path: "app/_layout.tsx"
      provides: "Stack screen registrations for paywall and manage-subscription"
      contains: "paywall"
  key_links:
    - from: "app/index.tsx"
      to: "src/hooks/useSubscriptionGate.ts"
      via: "useSubscriptionGate hook call"
      pattern: "useSubscriptionGate"
    - from: "app/index.tsx"
      to: "app/paywall.tsx"
      via: "Redirect href='/paywall'"
      pattern: "Redirect.*paywall"
    - from: "app/paywall.tsx"
      to: "src/hooks/useMockPurchase.ts"
      via: "useMockPurchase hook for purchase flow"
      pattern: "useMockPurchase"
    - from: "app/paywall.tsx"
      to: "src/constants/subscriptionPlans.ts"
      via: "SUBSCRIPTION_PLANS for plan card data"
      pattern: "SUBSCRIPTION_PLANS"
---

<objective>
Build the paywall screen and wire the subscription gate into the app's root redirect so non-subscribed parents see the paywall on launch.

Purpose: This is the primary user-facing deliverable -- the paywall screen that enforces the subscription requirement and presents plan options with mock purchase capability.
Output: Paywall screen accessible as both modal (from gate) and stack screen, plus updated root redirect with subscription check.
</objective>

<execution_context>
@/Users/robertisrael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertisrael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-subscription-ui-gates/04-CONTEXT.md
@.planning/phases/04-subscription-ui-gates/04-RESEARCH.md
@.planning/phases/04-subscription-ui-gates/04-01-SUMMARY.md
@app/index.tsx
@app/_layout.tsx
@src/hooks/useSubscriptionStatus.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create paywall screen</name>
  <files>app/paywall.tsx</files>
  <action>
Create `app/paywall.tsx` -- the paywall screen shown to non-subscribed parents.

**Layout (top to bottom):**
1. Header with X close button (top-right, Ionicons 'close' icon, 28px, onPress navigates back to index which re-gates). Title: "Choose Your Plan" centered.
2. Subtitle text: "Start your 7-day free trial today"
3. BillingToggle section: two buttons (Monthly / Annual) with active state highlighting. Annual button has a small "Save X%" badge using `getAnnualSavingsPercent` from the Premium plan (representative). State: `billingInterval` ('month' | 'year'), default 'month'.
4. Three vertical PlanCard components stacked:
   - Each card shows: plan.name, plan.description, price (formatted with $/mo or $/yr), studentLimit text, featureCount text, "Start Free Trial" button
   - Premium card (midsize) has "Most Popular" badge rendered as an absolutely positioned small banner above the card
   - Selected/tapped plan triggers mock purchase
5. Trial disclosure fine print: "After your 7-day free trial, you will be charged [price] per [period]. Cancel anytime."
6. Subscribe area -- each card has its own CTA button. When tapped:
   - Call `useMockPurchase().purchase({ plan: selectedPlan.id, billingInterval })`
   - Show full-screen loading overlay with ActivityIndicator and "Processing..." text during purchase
   - On success: show brief success message (Alert.alert "Welcome!" with "Your 7-day free trial has started."), then `router.replace('/')` to re-evaluate gate (which now passes)
   - On error: Alert.alert with error message
7. "Already subscribed? Restore Purchases" link below the plans. Tapping it:
   - Shows loading spinner for 1.5 seconds
   - Queries `user_subscriptions` for current user with active/trialing status
   - If found: Alert "Subscription Restored!" and `router.replace('/')`
   - If not found: Alert "No Purchases Found" with message "No active subscription was found for this account."
8. Footer: "By subscribing, you agree to our [Terms of Service] and [Privacy Policy]" with tappable links using `Linking.openURL('https://centsiblescholar.com/terms')` and `Linking.openURL('https://centsiblescholar.com/privacy')`.

**Imports from Plan 01 artifacts:**
- `SUBSCRIPTION_PLANS, getAnnualSavingsPercent` from `../src/constants/subscriptionPlans`
- `useMockPurchase` from `../src/hooks/useMockPurchase`

**Styling:**
- Use existing color scheme: primary #4F46E5, background #F3F4F6, cards #fff with shadow
- ScrollView for the content (three cards may exceed screen height)
- Highlighted Premium card: slightly thicker border (#4F46E5), or subtle background tint (#EEF2FF)
- Badge: small absolutely positioned element with #4F46E5 background, white text, rounded corners
- 44pt minimum touch targets on all buttons
- SafeAreaView or appropriate safe area padding

**Important anti-patterns to avoid:**
- Do NOT use gestureEnabled on this screen when shown as modal (the X button handles dismiss; research Pitfall 4 says to use `gestureEnabled: false` in layout but the X button navigates back to index which re-gates, so swipe dismiss is also safe since index re-gates)
- Actually, set `gestureEnabled: false` in _layout.tsx for the paywall screen to prevent accidental swipe dismiss. The X button is the intentional dismiss path.

Build PlanCard and BillingToggle as local function components within paywall.tsx (not separate files) to keep this self-contained. They are only used here.
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Verify paywall.tsx exists and imports from Plan 01 artifacts.</verify>
  <done>Paywall screen renders three plan cards with billing toggle, trial disclosure, legal links, restore purchases link, and triggers mock purchase on plan selection.</done>
</task>

<task type="auto">
  <name>Task 2: Wire subscription gate into root redirect and register screens in layout</name>
  <files>app/index.tsx, app/_layout.tsx</files>
  <action>
**app/index.tsx -- Add subscription gate:**

Modify the existing root redirect to add subscription checking between auth and dashboard redirect.

Current flow: auth check -> role check -> student onboarding check -> redirect
New flow: auth check -> role check -> **subscription gate** -> student onboarding check -> redirect

Import `useSubscriptionGate` from `../src/hooks/useSubscriptionGate`.

Implementation:
1. Call `useSubscriptionGate()` unconditionally at top of component (React hooks rules) alongside existing hooks
2. After auth loading check, after user existence check, after userRole check, add subscription gate:

```
// Subscription gate (both parents and students)
const { gateStatus, isStudent: isStudentGate, error: subError, refetch: subRefetch } = useSubscriptionGate();

if (gateStatus === 'loading') {
  return <LoadingSpinner />;
}

if (gateStatus === 'error') {
  return <SubscriptionErrorScreen onRetry={subRefetch} />;
}

if (gateStatus === 'not_subscribed') {
  if (isStudentGate) {
    return <StudentNoSubscriptionScreen />;
  }
  return <Redirect href="/paywall" />;
}

// gateStatus === 'subscribed' -- continue to existing redirect logic
```

3. Add `SubscriptionErrorScreen` as a local component: centered layout with error icon (Ionicons 'alert-circle-outline'), "Unable to verify subscription" title, "Please check your connection and try again" subtitle, "Retry" button calling `subRefetch()`.

4. Add `StudentNoSubscriptionScreen` as a local component: centered layout with lock icon, "Subscription Required" title, "Your parent's subscription is not active. Please ask your parent to subscribe to continue using the app." text, "Sign Out" button that signs out the student.

5. Keep existing student onboarding check AFTER the subscription gate (student must be subscribed AND onboarded).

**CRITICAL: Avoid paywall flash for subscribed users (Pitfall 1).**
The loading state from useSubscriptionGate must be checked BEFORE any redirect decisions. The existing auth loading spinner already covers auth loading. The subscription gate's 'loading' status must also show a spinner. Do NOT redirect to paywall while subscription is still loading.

**app/_layout.tsx -- Register new screens:**

Add two new Stack.Screen entries after the existing screens:

```tsx
<Stack.Screen
  name="paywall"
  options={{
    presentation: 'modal',
    headerShown: false,
    gestureEnabled: false, // Prevent swipe dismiss -- X button is the only dismiss path
  }}
/>
<Stack.Screen
  name="manage-subscription"
  options={{
    title: 'Manage Subscription',
  }}
/>
```

Place them after the existing `grade-approval` Stack.Screen entry.
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Verify index.tsx imports useSubscriptionGate and has Redirect to /paywall. Verify _layout.tsx registers both paywall and manage-subscription screens.</verify>
  <done>Root redirect gates on subscription status (parent -> paywall, student -> contact parent screen). Layout registers paywall as modal with gesture disabled and manage-subscription as stack screen. No paywall flash for subscribed users.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `app/paywall.tsx` exists with plan cards, billing toggle, mock purchase integration
- `app/index.tsx` redirects non-subscribed parents to `/paywall`
- `app/index.tsx` shows "contact parent" screen for students with unsubscribed parent
- `app/index.tsx` shows error screen with retry on subscription check failure
- `app/_layout.tsx` registers paywall (modal, gestureEnabled: false) and manage-subscription
- No Stripe references, no web URLs for subscription management
</verification>

<success_criteria>
- Non-subscribed parent lands on paywall showing 3 plans with correct pricing
- Monthly/annual toggle updates prices and shows savings badge
- Premium card has "Most Popular" badge
- Mock purchase triggers loading state, writes subscription, redirects to dashboard
- Subscribed parent goes directly to dashboard (no flash)
- Student never sees paywall (sees "contact parent" if parent unsubscribed)
- Subscription error shows retry screen (not silent failure)
- Restore Purchases link checks for existing subscription
- Trial disclosure and legal links visible on paywall
</success_criteria>

<output>
After completion, create `.planning/phases/04-subscription-ui-gates/04-02-SUMMARY.md`
</output>
