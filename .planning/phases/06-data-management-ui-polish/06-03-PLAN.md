---
phase: 06-data-management-ui-polish
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/delete-account/index.ts
  - src/hooks/useAccountDeletion.ts
  - app/delete-account.tsx
  - app/(tabs)/settings.tsx
  - app/_layout.tsx
autonomous: true

must_haves:
  truths:
    - "Parent can navigate to Settings > Account > Delete Account"
    - "Warning screen shows 'All your data will be permanently deleted' and lists student count"
    - "User must type DELETE to confirm (case-sensitive)"
    - "Active subscription blocks deletion with 'Cancel your subscription first' message"
    - "Account deletion cascades: student auth users deleted, then parent auth user deleted"
    - "After successful deletion, user is signed out and redirected to login"
    - "Deletion errors show blocking message with contact support info"
    - "Students do not see the delete account option"
  artifacts:
    - path: "supabase/functions/delete-account/index.ts"
      provides: "Edge function that cascade-deletes parent and student accounts"
      min_lines: 80
    - path: "src/hooks/useAccountDeletion.ts"
      provides: "Hook managing deletion flow state, confirmation, edge function call"
      exports: ["useAccountDeletion"]
    - path: "app/delete-account.tsx"
      provides: "Two-step deletion confirmation screen (warning + type DELETE)"
      min_lines: 80
  key_links:
    - from: "app/(tabs)/settings.tsx"
      to: "app/delete-account.tsx"
      via: "router.push('/delete-account')"
      pattern: "router\\.push.*delete-account"
    - from: "src/hooks/useAccountDeletion.ts"
      to: "supabase/functions/delete-account"
      via: "supabase.functions.invoke('delete-account')"
      pattern: "functions\\.invoke.*delete-account"
    - from: "supabase/functions/delete-account/index.ts"
      to: "supabaseAdmin.auth.admin.deleteUser"
      via: "Cascade deletion of auth users"
      pattern: "auth\\.admin\\.deleteUser"
    - from: "src/hooks/useAccountDeletion.ts"
      to: "signOut from supabase client"
      via: "Signs out after successful deletion"
      pattern: "signOut"
---

<objective>
Build the complete account deletion feature: server-side cascade deletion via edge function, client-side deletion hook, and two-step confirmation screen accessible from Settings.

Purpose: Apple requires account deletion capability. Parents must be able to permanently delete their account and all associated data (including student accounts) through an in-app flow.

Output: Working deletion flow from Settings > Account > Delete Account through warning screen, DELETE confirmation, to sign-out.
</objective>

<execution_context>
@/Users/robertisrael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertisrael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-data-management-ui-polish/06-CONTEXT.md
@.planning/phases/06-data-management-ui-polish/06-RESEARCH.md
@supabase/functions/revenuecat-webhook/index.ts
@src/integrations/supabase/client.ts
@src/hooks/useSubscriptionStatus.ts
@app/(tabs)/settings.tsx
@app/_layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create delete-account Supabase edge function</name>
  <files>
    supabase/functions/delete-account/index.ts
  </files>
  <action>
    Create `supabase/functions/delete-account/index.ts` following the exact pattern from the web app's `delete-student/index.ts` edge function.

    **Structure:**
    1. CORS headers (same as delete-student: `Access-Control-Allow-Origin: *`, authorization, x-client-info, apikey, content-type)
    2. Handle OPTIONS preflight
    3. Initialize supabaseAdmin with service_role key (same createClient pattern as delete-student)
    4. Authenticate requesting user:
       - Extract bearer token from Authorization header
       - Call `supabaseAdmin.auth.getUser(token)` to verify identity
       - Return 401 if invalid

    **Pre-deletion checks:**
    5. Verify user is a parent: Check `user.user_metadata?.user_type === 'parent'`. Students cannot delete accounts. Return 403 if student.
    6. Check subscription status:
       ```typescript
       const { data: subscription } = await supabaseAdmin
         .from('user_subscriptions')
         .select('status')
         .eq('user_id', user.id)
         .in('status', ['active', 'trialing'])
         .maybeSingle();
       ```
       If subscription exists and is active/trialing, return 400 with error: "Please cancel your subscription before deleting your account. You can manage your subscription in the App Store or Google Play."

    **Cascade deletion (following delete-student pattern):**
    7. Find all student relationships:
       ```typescript
       const { data: students } = await supabaseAdmin
         .from('parent_student_relationships')
         .select('student_user_id')
         .eq('parent_user_id', user.id);
       ```
    8. Delete each student's auth user (CASCADE handles their data):
       ```typescript
       const studentCount = students?.length || 0;
       for (const student of students || []) {
         const { error: studentDeleteError } = await supabaseAdmin.auth.admin.deleteUser(student.student_user_id);
         if (studentDeleteError) {
           console.error('[DELETE-ACCOUNT] Failed to delete student:', student.student_user_id, studentDeleteError);
           throw new Error(`Failed to delete student account. Please contact support.`);
         }
       }
       ```
    9. Delete the parent's auth user (CASCADE handles parent_profiles, etc.):
       ```typescript
       const { error: deleteError } = await supabaseAdmin.auth.admin.deleteUser(user.id);
       if (deleteError) {
         console.error('[DELETE-ACCOUNT] Failed to delete parent user:', deleteError);
         throw deleteError;
       }
       ```

    **CRITICAL: Delete auth users FIRST. Foreign key CASCADE handles public table cleanup. Do NOT manually delete from public tables before auth.admin.deleteUser.**

    10. Return success response:
        ```json
        { "success": true, "message": "Account deleted successfully", "studentsDeleted": N }
        ```

    **Error handling:**
    - Wrap entire flow in try/catch
    - On error: return 500 with `{ success: false, error: message }`
    - Use structured logging: `console.log('[DELETE-ACCOUNT] step', details)`

    **Logging steps:**
    - Log: request received, user authenticated, subscription check result, student count, each student deletion, parent deletion, success/failure
  </action>
  <verify>
    - File exists at `supabase/functions/delete-account/index.ts`
    - Contains CORS headers matching delete-student pattern
    - Auth verification via getUser(token)
    - Subscription status check before allowing deletion
    - Student auth users deleted BEFORE parent auth user
    - Uses auth.admin.deleteUser (not manual table deletes)
    - `npx tsc --noEmit` still passes (edge function excluded from tsconfig)
  </verify>
  <done>
    Edge function authenticates user, checks subscription status, cascade-deletes student auth users, then deletes parent auth user. Foreign key CASCADE handles all public table cleanup.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useAccountDeletion hook, delete-account screen, and wire into Settings</name>
  <files>
    src/hooks/useAccountDeletion.ts
    app/delete-account.tsx
    app/(tabs)/settings.tsx
    app/_layout.tsx
  </files>
  <action>
    1. **Create `src/hooks/useAccountDeletion.ts`:**
       - State: `{ isDeleting: boolean, error: string | null, step: 'warning' | 'confirm' | 'deleting' }`
       - `checkCanDelete()`: Checks if user has active subscription via `useSubscriptionStatus()`. Returns `{ canDelete: boolean, reason?: string }`. If isActive is true, reason = "Cancel your subscription first."
       - `fetchStudentCount()`: Queries `parent_student_relationships` count for current user. Returns number for warning message.
       - `deleteAccount()`:
         a. Set step='deleting', isDeleting=true
         b. Call `supabase.functions.invoke('delete-account')`
         c. If error response (e.g., subscription still active), set error state and return
         d. On success: call `signOut()` from supabase client
         e. Navigate to `/(auth)/login` via `router.replace('/(auth)/login')`
       - On error: set error string, reset isDeleting=false, step back to 'confirm'
       - Import signOut from `@/integrations/supabase/client`
       - Import router from expo-router

    2. **Create `app/delete-account.tsx`:**
       Two-step flow rendered as a single screen with step state:

       **Step 1 - Warning:**
       - Red warning icon (alert-circle or warning, size 64) at top
       - Title: "Delete Your Account" (h2 style)
       - Warning text: "This action is permanent and cannot be undone. All your data will be deleted, including:"
       - Bullet list: "Your profile and settings", "Grade records and transcripts", "Behavior assessments and scores", "Question of the Day history", "Earnings and savings goals"
       - If parent has students: additional red warning box: "This will also permanently delete {N} student account(s) and all their data."
       - If active subscription: show error box: "You must cancel your subscription before deleting your account." with "Manage Subscription" link button that navigates to manage-subscription screen
       - Two buttons at bottom:
         - "Cancel" (outline style, navigates back)
         - "Continue" (red destructive button, 44pt height) -- disabled if active subscription
         - Pressing Continue advances to Step 2

       **Step 2 - Confirmation:**
       - Title: "Confirm Deletion"
       - Instruction: "Type DELETE below to confirm account deletion."
       - TextInput for typing DELETE
       - Validation: compare input to "DELETE" (case-sensitive, trimmed)
       - Two buttons:
         - "Go Back" (outline, returns to Step 1)
         - "Delete My Account" (red destructive button, 44pt height) -- disabled until input === "DELETE"
       - Pressing "Delete My Account" calls hook's `deleteAccount()`

       **Deleting state:**
       - While isDeleting: show ActivityIndicator with "Deleting your account..." text
       - Disable all buttons

       **Error state:**
       - On error: show red error card with error message and "Contact support at support@centsiblescholar.com"
       - Show "Try Again" button

       **Colors:** Use existing theme imports (will be migrated to useTheme in Plan 04)

    3. **Update `app/(tabs)/settings.tsx`:**
       - Replace the existing `handleDeleteAccount` function (which currently opens a web URL) with navigation to the new screen: `router.push('/delete-account' as any)`
       - The existing "Delete Account" row in the Account section stays as-is visually (red text, same position)
       - Only show the Delete Account row for parents (`isParent` guard) -- add `{isParent && ...}` wrapper around the delete TouchableOpacity if not already present
       - Remove the Alert.alert confirmation dialog from handleDeleteAccount -- the delete-account screen handles all confirmation now

    4. **Update `app/_layout.tsx`:**
       - Add Stack.Screen for delete-account:
         ```tsx
         <Stack.Screen
           name="delete-account"
           options={{
             title: 'Delete Account',
             headerStyle: { backgroundColor: '#EF4444' },
             headerTintColor: '#fff',
           }}
         />
         ```
       - Use red header to signal destructive action
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Settings "Delete Account" row navigates to delete-account screen (not web URL)
    - delete-account.tsx renders Step 1 (warning) and Step 2 (type DELETE) flow
    - Delete button disabled until "DELETE" typed exactly
    - Active subscription blocks deletion with helpful message
    - useAccountDeletion hook calls edge function and signs out on success
    - Stack.Screen registered for delete-account route
    - Students do not see Delete Account option
  </verify>
  <done>
    Complete account deletion flow: parent taps Delete Account in Settings > Account, sees warning with data list and student count, taps Continue, types DELETE to confirm, account cascades deleted, user signed out and returned to login screen. Active subscriptions must be canceled first.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no type errors
2. Edge function exists with proper cascade deletion pattern (students first, then parent)
3. Subscription check blocks deletion when active
4. Settings Delete Account row navigates to in-app screen (not external URL)
5. Two-step confirmation: warning then type DELETE
6. After deletion: user signed out and at login screen
7. Delete Account hidden for students
</verification>

<success_criteria>
- Edge function cascade-deletes: student auth users first, then parent auth user, using auth.admin.deleteUser
- Active subscription check prevents deletion with helpful message
- Two-step confirmation: warning screen then "Type DELETE" screen
- Parent with students sees "This will also delete N student accounts" warning
- Successful deletion signs user out and redirects to login
- Deletion errors show blocking message with support contact
- Students cannot see or access account deletion
- Red destructive UI styling signals danger appropriately
</success_criteria>

<output>
After completion, create `.planning/phases/06-data-management-ui-polish/06-03-SUMMARY.md`
</output>
