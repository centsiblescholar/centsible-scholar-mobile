---
phase: 06-data-management-ui-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/export-user-data/index.ts
  - src/hooks/useDataExport.ts
  - app/data-export.tsx
  - app/(tabs)/settings.tsx
  - app/_layout.tsx
autonomous: true

must_haves:
  truths:
    - "Parent can navigate to Settings > Privacy > Export My Data"
    - "Export preview screen shows data summary (record counts, estimated size) before export"
    - "Parent can choose between JSON or CSV format"
    - "Parent can toggle 'Include student data' checkbox"
    - "JSON format exports a single .json file via share sheet"
    - "CSV format exports a .zip file containing multiple CSVs (students.csv, grades.csv, etc.) via share sheet"
    - "ZIP creation happens server-side in the edge function (not client-side)"
    - "Progress modal shows during export preparation"
    - "Export errors show an alert with Retry button"
    - "Students do not see the export option in Settings"
  artifacts:
    - path: "supabase/functions/export-user-data/index.ts"
      provides: "Edge function that gathers all user data and returns JSON or base64-encoded ZIP with multiple CSVs"
      min_lines: 80
    - path: "src/hooks/useDataExport.ts"
      provides: "Hook managing export flow state, edge function call, file writing, sharing"
      exports: ["useDataExport"]
    - path: "app/data-export.tsx"
      provides: "Export preview screen with format selection, student toggle, summary, and export button"
      min_lines: 60
  key_links:
    - from: "app/(tabs)/settings.tsx"
      to: "app/data-export.tsx"
      via: "router.push('/data-export')"
      pattern: "router\\.push.*data-export"
    - from: "src/hooks/useDataExport.ts"
      to: "supabase/functions/export-user-data"
      via: "supabase.functions.invoke('export-user-data')"
      pattern: "functions\\.invoke.*export-user-data"
    - from: "src/hooks/useDataExport.ts"
      to: "expo-sharing"
      via: "Sharing.shareAsync for native share sheet"
      pattern: "Sharing\\.shareAsync"
    - from: "src/hooks/useDataExport.ts"
      to: "expo-file-system"
      via: "File class to write export data to cache"
      pattern: "new File.*Paths\\.cache"
---

<objective>
Build the complete GDPR-compliant data export feature: server-side data gathering via edge function with ZIP creation for CSV format, client-side export hook with file writing and share sheet, and export preview screen accessible from Settings.

Purpose: Apple requires the ability for users to export their personal data. This feature lets parents export all family data as a single JSON file or as a ZIP containing multiple CSVs (students.csv, grades.csv, assessments.csv, etc.) via the native share sheet.

Output: Working data export flow from Settings > Privacy > Export My Data through preview screen to share sheet. CSV format produces a real ZIP file with separate CSVs per table, created server-side in the edge function.
</objective>

<execution_context>
@/Users/robertisrael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertisrael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-data-management-ui-polish/06-CONTEXT.md
@.planning/phases/06-data-management-ui-polish/06-RESEARCH.md
@supabase/functions/revenuecat-webhook/index.ts
@src/integrations/supabase/client.ts
@app/(tabs)/settings.tsx
@app/_layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create export-user-data Supabase edge function with server-side ZIP creation</name>
  <files>
    supabase/functions/export-user-data/index.ts
  </files>
  <action>
    Create `supabase/functions/export-user-data/index.ts` following the same patterns as the existing `revenuecat-webhook` and the web app's `delete-student` edge functions.

    **Structure:**
    1. CORS headers (same pattern as delete-student: `Access-Control-Allow-Origin: *`, etc.)
    2. Handle OPTIONS preflight
    3. Initialize supabaseAdmin with service_role key (same pattern as delete-student)
    4. Authenticate requesting user via Authorization bearer token using `supabaseAdmin.auth.getUser(token)`
    5. Parse request body: `{ format: 'json' | 'csv', includeStudents: boolean }`
    6. Verify user is a parent (check `user_metadata.user_type === 'parent'`; students cannot export)

    **Data gathering (use Promise.all for parallel queries):**
    Query these tables filtered by user_id, using supabaseAdmin (bypasses RLS):
    - `parent_profiles` (eq user_id)
    - `user_subscriptions` (eq user_id) -- select only: status, subscription_type, current_period_start, current_period_end, platform (exclude payment IDs)
    - If includeStudents:
      - `parent_student_relationships` (eq parent_user_id) -> get student_user_ids
      - For each student: `student_profiles`, `student_grades`, `behavior_assessments`, `behavior_assessments_complete`, `question_of_day_results`, `savings_goals`, `behavior_bonuses`, `student_badges`
    - `family_meetings` (eq user_id)
    - `term_configs` (eq user_id)
    - `term_snapshots` (eq user_id)

    **JSON format response:**
    ```json
    {
      "format": "json",
      "content": {
        "export_date": "2026-02-11T...",
        "profile": {...},
        "subscription": {...},
        "students": [...],
        "family_meetings": [...],
        "term_configs": [...],
        "term_snapshots": [...]
      },
      "summary": {
        "students": 2,
        "grades": 145,
        "assessments": 89,
        "qod_answers": 200,
        ...
      }
    }
    ```

    **CSV/ZIP format response:**
    For CSV format, create a real ZIP file server-side containing multiple CSV files. The edge function runs in Deno which has proper ZIP support.

    1. Implement `escapeCsvValue()` and `arrayToCsv()` helper functions:
       - Wrap values containing commas, newlines, or double quotes in double quotes
       - Escape embedded double quotes by doubling them
       - Handle null/undefined as empty string

    2. Generate individual CSV strings for each table:
       - `profile.csv` (parent profile data)
       - `subscription.csv` (subscription status)
       - `students.csv` (student profiles, if included)
       - `grades.csv` (all student grades, if included)
       - `assessments.csv` (behavior assessments, if included)
       - `qod_results.csv` (question of the day results, if included)
       - `savings_goals.csv` (if included)
       - `behavior_bonuses.csv` (if included)
       - `badges.csv` (if included)
       - `family_meetings.csv`
       - `term_configs.csv`
       - `term_snapshots.csv`

    3. Create ZIP using Deno's built-in capabilities. Use the `JSZip` library from esm.sh (works in Deno unlike React Native):
       ```typescript
       import JSZip from 'https://esm.sh/jszip@3.10.1';

       const zip = new JSZip();
       zip.file('profile.csv', profileCsv);
       zip.file('students.csv', studentsCsv);
       zip.file('grades.csv', gradesCsv);
       // ... add all CSV files

       const zipContent = await zip.generateAsync({ type: 'base64' });
       ```

       If JSZip from esm.sh doesn't work in Deno, fall back to manually constructing a ZIP using Deno's `std/archive` or using the `fflate` library from esm.sh:
       ```typescript
       import { zipSync, strToU8 } from 'https://esm.sh/fflate@0.8.2';

       const zipped = zipSync({
         'profile.csv': strToU8(profileCsv),
         'students.csv': strToU8(studentsCsv),
         'grades.csv': strToU8(gradesCsv),
         // ...
       });
       const base64 = btoa(String.fromCharCode(...new Uint8Array(zipped)));
       ```

    4. Return ZIP as base64-encoded string:
       ```json
       {
         "format": "csv",
         "zipBase64": "<base64-encoded-zip-content>",
         "filename": "centsible-scholar-export-2026-02-11.zip",
         "summary": {
           "students": 2,
           "grades": 145,
           "assessments": 89,
           ...
         }
       }
       ```

    **Error handling:**
    - Auth errors return 401
    - Non-parent users return 403
    - Query errors return 500 with error message
    - Use structured logging: `console.log('[EXPORT-USER-DATA] step', details)`

    **Important:** Exclude from tsconfig (already done in Phase 5 -- supabase/functions excluded). The edge function uses Deno types, not Node types.
  </action>
  <verify>
    - File exists at `supabase/functions/export-user-data/index.ts`
    - Contains CORS headers, auth verification, data queries, JSON and CSV/ZIP format handling
    - Uses `supabaseAdmin.auth.getUser(token)` for authentication
    - Uses `Promise.all` for parallel data queries
    - CSV escaping handles commas, newlines, and double quotes
    - ZIP creation happens server-side using JSZip or fflate from esm.sh
    - ZIP response is base64-encoded
    - `npx tsc --noEmit` still passes (edge function excluded from tsconfig)
  </verify>
  <done>
    Edge function gathers all user-owned data from Supabase tables, returns either JSON object or base64-encoded ZIP containing multiple CSV files (one per table), with summary counts, using service_role to bypass RLS.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useDataExport hook, data-export screen, and wire into Settings</name>
  <files>
    src/hooks/useDataExport.ts
    app/data-export.tsx
    app/(tabs)/settings.tsx
    app/_layout.tsx
  </files>
  <action>
    1. **Create `src/hooks/useDataExport.ts`:**
       - State: `{ isLoading, progress, error, summary, exportData }`
       - `fetchSummary()`: Calls edge function with a `summaryOnly: true` flag (or calls it and just uses the summary portion). Sets summary state with record counts.
       - `exportData(format: 'json' | 'csv', includeStudents: boolean)`:
         a. Sets isLoading=true, progress=10
         b. Calls `supabase.functions.invoke('export-user-data', { body: { format, includeStudents } })`
         c. Sets progress=50 after response
         d. **If format === 'json':**
            - Write JSON string to file using new expo-file-system API:
              ```typescript
              import { File, Paths } from 'expo-file-system';
              const filename = `centsible-scholar-export-${new Date().toISOString().split('T')[0]}.json`;
              const file = new File(Paths.cache, filename);
              file.create();
              file.write(JSON.stringify(data.content, null, 2));
              ```
            - Share with mimeType `application/json`
         e. **If format === 'csv':**
            - Response contains `zipBase64` field with base64-encoded ZIP data
            - Decode base64 to binary and write as .zip file:
              ```typescript
              const filename = `centsible-scholar-export-${new Date().toISOString().split('T')[0]}.zip`;
              const file = new File(Paths.cache, filename);
              file.create();
              // Write base64 content -- use expo-file-system's base64 write capability
              // If File.write() only accepts strings, use the legacy API for binary:
              import * as FileSystemLegacy from 'expo-file-system/legacy';
              await FileSystemLegacy.writeAsStringAsync(
                FileSystemLegacy.cacheDirectory + filename,
                data.zipBase64,
                { encoding: FileSystemLegacy.EncodingType.Base64 }
              );
              const fileUri = FileSystemLegacy.cacheDirectory + filename;
              ```
            - Share with mimeType `application/zip`
         f. Sets progress=80
         g. Opens share sheet: `await Sharing.shareAsync(fileUri, { mimeType: '...', dialogTitle: 'Export Your Data' })`
         h. Sets progress=100, then isLoading=false
       - `retry()`: Clears error, re-runs last export
       - Handle errors: catch in try/catch, set error state, reset isLoading
       - IMPORTANT: For JSON, use new `File` API from `expo-file-system`. For ZIP (binary), use `writeAsStringAsync` with Base64 encoding from `expo-file-system/legacy` since the new File API may not support binary writing. Test both approaches and use whichever works.

    2. **Create `app/data-export.tsx`:**
       - Screen: Export preview with summary and export controls
       - On mount: call `fetchSummary()` to get data counts
       - Layout:
         a. Header area with shield/download icon and title "Export Your Data"
         b. Description: "Download a copy of all your Centsible Scholar data."
         c. Summary card showing counts: "X students, Y grades, Z assessments, W QOD answers" etc. Show skeleton while loading summary.
         d. Format selector: Two tappable cards/radio buttons:
            - "JSON (Single File)" -- description: "All data in one structured file"
            - "CSV (ZIP Archive)" -- description: "Separate spreadsheet files per data type"
            Highlight selected card.
         e. "Include Student Data" toggle (Switch component) with label -- only show for parents with students
         f. Export button (primary style, 44pt min height): "Export Data"
         g. When export running: show LoadingOverlay with progress
       - Colors: Use existing `colors` import from theme (will be migrated to useTheme in Plan 04)
       - File naming: `centsible-scholar-export-YYYY-MM-DD.json` or `.zip`
       - On error: Alert with "Export failed" message and "Retry" button
       - On success (share sheet dismissed): Optional "Export complete" toast or just return to screen

    3. **Update `app/(tabs)/settings.tsx`:**
       - Add a new "Privacy" section between the existing "Notifications" and "App" sections
       - Only visible when `isParent` is true (students cannot export)
       - Contains one row: "Export My Data" with a download-outline Ionicons icon and chevron
       - Tapping navigates to: `router.push('/data-export' as any)`
       - Style the section consistently with existing sections (same sectionTitle, card, linkRow patterns)

    4. **Update `app/_layout.tsx`:**
       - Add Stack.Screen for data-export:
         ```tsx
         <Stack.Screen
           name="data-export"
           options={{
             title: 'Export Data',
             presentation: 'modal',
           }}
         />
         ```
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Settings screen shows "Privacy" section with "Export My Data" for parents
    - data-export.tsx renders preview screen with format selection (JSON / CSV ZIP), student toggle, and export button
    - useDataExport hook calls edge function, writes file (.json or .zip), opens share sheet
    - CSV export produces a .zip file (not a single concatenated .csv)
    - Stack.Screen registered for data-export route
  </verify>
  <done>
    Complete data export flow: parent taps "Export My Data" in Settings > Privacy, sees preview with counts, selects format -- JSON (single file) or CSV (ZIP with multiple spreadsheets) -- and student data toggle, taps Export, sees progress overlay, native share sheet opens with .json or .zip file.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no type errors
2. Edge function file exists at correct path with proper Deno imports and CORS
3. Edge function creates real ZIP with multiple CSVs for CSV format (not concatenated single file)
4. Settings > Privacy section visible for parents, hidden for students
5. data-export screen shows summary counts, format selector (JSON / CSV ZIP), student toggle
6. JSON export produces .json file, CSV export produces .zip file
7. Export button triggers edge function call, file write, and share sheet
8. Error states show alert with retry
</verification>

<success_criteria>
- Edge function gathers data from all relevant Supabase tables using service_role key
- JSON format returns structured JSON object; CSV format returns base64-encoded ZIP containing multiple CSV files (one per table)
- ZIP creation happens server-side in the Deno edge function (not client-side in React Native)
- Parent can navigate Settings > Privacy > Export My Data
- Preview screen shows data summary before export
- Native share sheet opens with correctly named .json or .zip file
- Progress overlay shows during export
- Students cannot see or access export feature
- Errors show retry option
</success_criteria>

<output>
After completion, create `.planning/phases/06-data-management-ui-polish/06-02-SUMMARY.md`
</output>
