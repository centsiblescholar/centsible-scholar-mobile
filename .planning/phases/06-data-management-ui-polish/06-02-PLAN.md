---
phase: 06-data-management-ui-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/export-user-data/index.ts
  - src/hooks/useDataExport.ts
  - app/data-export.tsx
  - app/(tabs)/settings.tsx
  - app/_layout.tsx
autonomous: true

must_haves:
  truths:
    - "Parent can navigate to Settings > Privacy > Export My Data"
    - "Export preview screen shows data summary (record counts, estimated size) before export"
    - "Parent can choose between JSON or CSV format"
    - "Parent can toggle 'Include student data' checkbox"
    - "Tapping Export opens the native share sheet with the generated file"
    - "Progress modal shows during export preparation"
    - "Export errors show an alert with Retry button"
    - "Students do not see the export option in Settings"
  artifacts:
    - path: "supabase/functions/export-user-data/index.ts"
      provides: "Edge function that gathers all user data and returns JSON or CSV"
      min_lines: 80
    - path: "src/hooks/useDataExport.ts"
      provides: "Hook managing export flow state, edge function call, file writing, sharing"
      exports: ["useDataExport"]
    - path: "app/data-export.tsx"
      provides: "Export preview screen with format selection, student toggle, summary, and export button"
      min_lines: 60
  key_links:
    - from: "app/(tabs)/settings.tsx"
      to: "app/data-export.tsx"
      via: "router.push('/data-export')"
      pattern: "router\\.push.*data-export"
    - from: "src/hooks/useDataExport.ts"
      to: "supabase/functions/export-user-data"
      via: "supabase.functions.invoke('export-user-data')"
      pattern: "functions\\.invoke.*export-user-data"
    - from: "src/hooks/useDataExport.ts"
      to: "expo-sharing"
      via: "Sharing.shareAsync for native share sheet"
      pattern: "Sharing\\.shareAsync"
    - from: "src/hooks/useDataExport.ts"
      to: "expo-file-system"
      via: "File class to write export data to cache"
      pattern: "new File.*Paths\\.cache"
---

<objective>
Build the complete GDPR-compliant data export feature: server-side data gathering via edge function, client-side export hook with file writing and share sheet, and export preview screen accessible from Settings.

Purpose: Apple requires the ability for users to export their personal data. This feature lets parents export all family data as JSON or CSV via the native share sheet.

Output: Working data export flow from Settings > Privacy > Export My Data through preview screen to share sheet.
</objective>

<execution_context>
@/Users/robertisrael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertisrael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-data-management-ui-polish/06-CONTEXT.md
@.planning/phases/06-data-management-ui-polish/06-RESEARCH.md
@supabase/functions/revenuecat-webhook/index.ts
@src/integrations/supabase/client.ts
@app/(tabs)/settings.tsx
@app/_layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create export-user-data Supabase edge function</name>
  <files>
    supabase/functions/export-user-data/index.ts
  </files>
  <action>
    Create `supabase/functions/export-user-data/index.ts` following the same patterns as the existing `revenuecat-webhook` and the web app's `delete-student` edge functions.

    **Structure:**
    1. CORS headers (same pattern as delete-student: `Access-Control-Allow-Origin: *`, etc.)
    2. Handle OPTIONS preflight
    3. Initialize supabaseAdmin with service_role key (same pattern as delete-student)
    4. Authenticate requesting user via Authorization bearer token using `supabaseAdmin.auth.getUser(token)`
    5. Parse request body: `{ format: 'json' | 'csv', includeStudents: boolean }`
    6. Verify user is a parent (check `user_metadata.user_type === 'parent'`; students cannot export)

    **Data gathering (use Promise.all for parallel queries):**
    Query these tables filtered by user_id, using supabaseAdmin (bypasses RLS):
    - `parent_profiles` (eq user_id)
    - `user_subscriptions` (eq user_id) -- select only: status, subscription_type, current_period_start, current_period_end, platform (exclude payment IDs)
    - If includeStudents:
      - `parent_student_relationships` (eq parent_user_id) -> get student_user_ids
      - For each student: `student_profiles`, `student_grades`, `behavior_assessments`, `behavior_assessments_complete`, `question_of_day_results`, `savings_goals`, `behavior_bonuses`, `student_badges`
    - `family_meetings` (eq user_id)
    - `term_configs` (eq user_id)
    - `term_snapshots` (eq user_id)

    **JSON format response:**
    ```json
    {
      "format": "json",
      "content": {
        "export_date": "2026-02-11T...",
        "profile": {...},
        "subscription": {...},
        "students": [...],
        "family_meetings": [...],
        "term_configs": [...],
        "term_snapshots": [...]
      },
      "summary": {
        "students": 2,
        "grades": 145,
        "assessments": 89,
        "qod_answers": 200,
        ...
      }
    }
    ```

    **CSV format response:**
    For CSV, return a JSON response with multiple CSV strings (one per table):
    ```json
    {
      "format": "csv",
      "files": {
        "profile.csv": "name,email,...\nJohn,john@...",
        "students.csv": "...",
        "grades.csv": "...",
        ...
      },
      "summary": { ... }
    }
    ```

    **CSV formatting:**
    Implement `escapeCsvValue()` and `arrayToCsv()` helper functions inside the edge function:
    - Wrap values containing commas, newlines, or double quotes in double quotes
    - Escape embedded double quotes by doubling them
    - Handle null/undefined as empty string

    **Error handling:**
    - Auth errors return 401
    - Non-parent users return 403
    - Query errors return 500 with error message
    - Use structured logging: `console.log('[EXPORT-USER-DATA] step', details)`

    **Important:** Exclude from tsconfig (already done in Phase 5 -- supabase/functions excluded). The edge function uses Deno types, not Node types.
  </action>
  <verify>
    - File exists at `supabase/functions/export-user-data/index.ts`
    - Contains CORS headers, auth verification, data queries, JSON and CSV format handling
    - Uses `supabaseAdmin.auth.getUser(token)` for authentication
    - Uses `Promise.all` for parallel data queries
    - CSV escaping handles commas, newlines, and double quotes
    - `npx tsc --noEmit` still passes (edge function excluded from tsconfig)
  </verify>
  <done>
    Edge function gathers all user-owned data from Supabase tables, returns either JSON object or CSV file strings with summary counts, using service_role to bypass RLS.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useDataExport hook, data-export screen, and wire into Settings</name>
  <files>
    src/hooks/useDataExport.ts
    app/data-export.tsx
    app/(tabs)/settings.tsx
    app/_layout.tsx
  </files>
  <action>
    1. **Create `src/hooks/useDataExport.ts`:**
       - State: `{ isLoading, progress, error, summary, exportData }`
       - `fetchSummary()`: Calls edge function with a `summaryOnly: true` flag (or calls it and just uses the summary portion). Sets summary state with record counts.
       - `exportData(format: 'json' | 'csv', includeStudents: boolean)`:
         a. Sets isLoading=true, progress=10
         b. Calls `supabase.functions.invoke('export-user-data', { body: { format, includeStudents } })`
         c. Sets progress=50 after response
         d. If format === 'json': write JSON string to file
         e. If format === 'csv': write each CSV file individually OR concatenate into single file with section headers
         f. Uses new expo-file-system API:
            ```typescript
            import { File, Paths } from 'expo-file-system';
            const filename = `centsible-scholar-export-${new Date().toISOString().split('T')[0]}.${format === 'json' ? 'json' : 'csv'}`;
            const file = new File(Paths.cache, filename);
            file.create();
            file.write(content);
            ```
         g. Sets progress=80
         h. Opens share sheet: `await Sharing.shareAsync(file.uri, { mimeType: '...', dialogTitle: 'Export Your Data' })`
         i. Sets progress=100, then isLoading=false
       - `retry()`: Clears error, re-runs last export
       - Handle errors: catch in try/catch, set error state, reset isLoading
       - IMPORTANT: Use `import { File, Paths } from 'expo-file-system'` (new SDK 54 API), NOT the legacy `writeAsStringAsync`
       - IMPORTANT: For CSV format, since ZIP won't work in RN, concatenate all CSV tables into a single .csv file with clear section headers like `\n\n--- STUDENTS ---\n` between tables. This avoids the ZIP complexity entirely while still providing CSV data.

    2. **Create `app/data-export.tsx`:**
       - Screen: Export preview with summary and export controls
       - On mount: call `fetchSummary()` to get data counts
       - Layout:
         a. Header area with shield/download icon and title "Export Your Data"
         b. Description: "Download a copy of all your Centsible Scholar data."
         c. Summary card showing counts: "X students, Y grades, Z assessments, W QOD answers" etc. Show skeleton while loading summary.
         d. Format selector: Two tappable cards/radio buttons -- "JSON (Single File)" and "CSV (Spreadsheet)" -- highlight selected
         e. "Include Student Data" toggle (Switch component) with label -- only show for parents with students
         f. Export button (primary style, 44pt min height): "Export Data"
         g. When export running: show LoadingOverlay with progress
       - Colors: Use existing `colors` import from theme (will be migrated to useTheme in Plan 04)
       - File naming: `centsible-scholar-export-YYYY-MM-DD.json` or `.csv`
       - On error: Alert with "Export failed" message and "Retry" button
       - On success (share sheet dismissed): Optional "Export complete" toast or just return to screen

    3. **Update `app/(tabs)/settings.tsx`:**
       - Add a new "Privacy" section between the existing "Notifications" and "App" sections
       - Only visible when `isParent` is true (students cannot export)
       - Contains one row: "Export My Data" with a download-outline Ionicons icon and chevron
       - Tapping navigates to: `router.push('/data-export' as any)`
       - Style the section consistently with existing sections (same sectionTitle, card, linkRow patterns)

    4. **Update `app/_layout.tsx`:**
       - Add Stack.Screen for data-export:
         ```tsx
         <Stack.Screen
           name="data-export"
           options={{
             title: 'Export Data',
             presentation: 'modal',
           }}
         />
         ```
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Settings screen shows "Privacy" section with "Export My Data" for parents
    - data-export.tsx renders preview screen with format selection, student toggle, and export button
    - useDataExport hook calls edge function, writes file, opens share sheet
    - Stack.Screen registered for data-export route
  </verify>
  <done>
    Complete data export flow: parent taps "Export My Data" in Settings > Privacy, sees preview with counts, selects format (JSON/CSV) and student data toggle, taps Export, sees progress overlay, native share sheet opens with file.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no type errors
2. Edge function file exists at correct path with proper Deno imports and CORS
3. Settings > Privacy section visible for parents, hidden for students
4. data-export screen shows summary counts, format selector, student toggle
5. Export button triggers edge function call, file write, and share sheet
6. Error states show alert with retry
</verification>

<success_criteria>
- Edge function gathers data from all relevant Supabase tables using service_role key
- Both JSON and CSV export formats work end to end
- Parent can navigate Settings > Privacy > Export My Data
- Preview screen shows data summary before export
- Native share sheet opens with correctly named file
- Progress overlay shows during export
- Students cannot see or access export feature
- Errors show retry option
</success_criteria>

<output>
After completion, create `.planning/phases/06-data-management-ui-polish/06-02-SUMMARY.md`
</output>
