---
phase: 02-auth-student-routing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260205_add_student_onboarding_column.sql
  - app/(tabs)/dashboard.tsx
  - app/(tabs)/_layout.tsx
  - app/index.tsx
  - src/hooks/useStudentProfile.ts
autonomous: true

must_haves:
  truths:
    - "Student signs in and sees a student-specific dashboard with GPA, earnings, streak, and behavior score as horizontal scrollable cards"
    - "Student sees 'Today's Tasks' section at top of dashboard showing QOD and behavior check-in status"
    - "Student sees their reward structure transparently (base amount per grade visible)"
    - "Student sees full allocation breakdown (taxes, retirement, savings, discretionary)"
    - "Student tab bar shows exactly 5 tabs: Dashboard, Grades, Behavior, Learn, Settings"
    - "Parent-only tabs and management features are invisible to students"
    - "Parent still sees all 6 tabs and can switch between students"
    - "Student routing gates on has_completed_onboarding (redirects to onboarding if false)"
  artifacts:
    - path: "supabase/migrations/20260205_add_student_onboarding_column.sql"
      provides: "has_completed_onboarding column on student_profiles"
      contains: "has_completed_onboarding"
    - path: "app/(tabs)/dashboard.tsx"
      provides: "Role-aware dashboard (parent view unchanged, student view with horizontal metric cards)"
      min_lines: 100
    - path: "app/(tabs)/_layout.tsx"
      provides: "Role-aware tab bar hiding parent-only features from students"
      contains: "href.*null"
    - path: "app/index.tsx"
      provides: "Student onboarding gate checking has_completed_onboarding"
      contains: "has_completed_onboarding"
    - path: "src/hooks/useStudentProfile.ts"
      provides: "StudentProfile interface with has_completed_onboarding field"
      contains: "has_completed_onboarding"
  key_links:
    - from: "app/index.tsx"
      to: "src/hooks/useStudentProfile.ts"
      via: "useStudentProfile hook for onboarding check"
      pattern: "useStudentProfile"
    - from: "app/(tabs)/dashboard.tsx"
      to: "src/hooks/useStudentGrades.ts"
      via: "useStudentGrades for GPA and earnings"
      pattern: "useStudentGrades"
    - from: "app/(tabs)/dashboard.tsx"
      to: "src/hooks/useBehaviorAssessments.ts"
      via: "useBehaviorAssessments for behavior score"
      pattern: "useBehaviorAssessments"
    - from: "app/(tabs)/dashboard.tsx"
      to: "src/hooks/useEducationBonus.ts"
      via: "useEducationBonus for streak data"
      pattern: "useEducationBonus"
    - from: "app/(tabs)/_layout.tsx"
      to: "src/contexts/AuthContext.tsx"
      via: "useAuth for userRole-based tab visibility"
      pattern: "userRole.*student.*null"
---

<objective>
Build the student-specific dashboard experience and role-based tab routing so students see their own personalized view with action-first design.

Purpose: Students need to sign in independently and land on a dashboard designed for them -- showing today's tasks prominently, their key metrics as swipeable cards, and full financial transparency. The parent experience must remain completely unchanged.

Output: Student dashboard with horizontal scrollable metric cards, role-aware tab bar (5 student tabs vs 6 parent tabs), onboarding gate in routing, and DB migration for onboarding tracking.
</objective>

<execution_context>
@/Users/robertisrael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertisrael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-architecture-foundation/01-01-SUMMARY.md

Key files:
@app/(tabs)/dashboard.tsx -- Current parent dashboard, needs student view added
@app/(tabs)/_layout.tsx -- Tab layout with role-based href:null pattern (Earnings already hidden from students)
@app/index.tsx -- Root routing, needs onboarding gate for students
@src/contexts/AuthContext.tsx -- Provides userRole ('parent' | 'student')
@src/contexts/StudentContext.tsx -- StudentProvider with selectedStudent, isParentView
@src/hooks/useStudentProfile.ts -- Needs has_completed_onboarding field
@src/hooks/useStudentGrades.ts -- Existing hook for GPA, grades, rewards
@src/hooks/useBehaviorAssessments.ts -- Existing hook for behavior score
@src/hooks/useEducationBonus.ts -- Existing hook for QOD accuracy and streak
@src/hooks/useBehaviorBonus.ts -- Existing hook for behavior bonus
@src/theme/colors.ts -- Design system with indigo, financial, semantic colors
</context>

<tasks>

<task type="auto">
  <name>Task 1: DB migration + useStudentProfile update + routing gate</name>
  <files>
    supabase/migrations/20260205_add_student_onboarding_column.sql
    src/hooks/useStudentProfile.ts
    app/index.tsx
  </files>
  <action>
**1. Create SQL migration: `supabase/migrations/20260205_add_student_onboarding_column.sql`**

```sql
-- Add onboarding tracking for student profiles
ALTER TABLE student_profiles
ADD COLUMN IF NOT EXISTS has_completed_onboarding BOOLEAN DEFAULT false;

-- Comment for documentation
COMMENT ON COLUMN student_profiles.has_completed_onboarding IS 'Tracks whether student has completed the required interactive onboarding tutorial';
```

**2. Update `src/hooks/useStudentProfile.ts`:**

Add `has_completed_onboarding` to the `StudentProfile` interface:
```typescript
export interface StudentProfile {
  id: string;
  user_id: string;
  name: string;
  email: string | null;
  grade_level: string;
  base_reward_amount: number;
  is_active: boolean;
  reporting_frequency: string;
  has_completed_onboarding: boolean;  // NEW
}
```

The hook already does `select('*')` so the new column will be included automatically. Since migration may not be applied yet, add a safe fallback in the hook's return: treat missing/null `has_completed_onboarding` as `false`.

After the interface update, add a helper function to the hook file:
```typescript
/** Safe accessor -- treats null/undefined as false (pre-migration compat) */
function safeOnboardingStatus(profile: StudentProfile | null): boolean {
  return profile?.has_completed_onboarding ?? false;
}
```

Export this function and also return `hasCompletedOnboarding: safeOnboardingStatus(profile)` from the hook alongside the existing `hasProfile` return.

**3. Update `app/index.tsx` to gate student onboarding:**

Import `useStudentProfile` and `useAuth`. After the existing role check logic:

For students (`userRole === 'student'`):
- Call `useStudentProfile()` at the top level of the component (hooks must be unconditional)
- If `userRole === 'student'` and profile is still loading, show spinner
- If `userRole === 'student'` and `!hasCompletedOnboarding`, redirect to `/(onboarding)` (this route will be created in Plan 03; for now the redirect target should be set but if the route doesn't exist yet, Expo Router will just show 404 -- this is fine, Plan 03 creates it)
- If `userRole === 'student'` and `hasCompletedOnboarding`, redirect to `/(tabs)/dashboard` (existing behavior)

For parents (`userRole === 'parent'`):
- Keep existing behavior: redirect straight to `/(tabs)/dashboard`

The updated routing logic should be:
```typescript
// Parent goes straight to dashboard
if (userRole === 'parent') {
  return <Redirect href="/(tabs)/dashboard" />;
}

// Student: check onboarding status
if (userRole === 'student') {
  if (profileLoading) {
    return <View style={styles.container}><ActivityIndicator size="large" color="#4F46E5" /></View>;
  }
  if (!hasCompletedOnboarding) {
    return <Redirect href="/(onboarding)" />;
  }
  return <Redirect href="/(tabs)/dashboard" />;
}
```

IMPORTANT: The `useStudentProfile` hook must be called unconditionally (React rules of hooks). Conditionals only go in the return/render logic.
  </action>
  <verify>
- `npx tsc --noEmit` passes with zero errors
- SQL migration file exists with ALTER TABLE adding has_completed_onboarding
- useStudentProfile exports hasCompletedOnboarding
- index.tsx imports useStudentProfile and conditionally redirects students based on onboarding status
  </verify>
  <done>
- Migration file ready to apply (adds has_completed_onboarding boolean defaulting to false)
- useStudentProfile returns hasCompletedOnboarding (false for pre-migration compat)
- Student routing: incomplete onboarding -> /(onboarding), complete -> /(tabs)/dashboard
- Parent routing unchanged: always goes to /(tabs)/dashboard
  </done>
</task>

<task type="auto">
  <name>Task 2: Student dashboard view with horizontal metric cards + tab bar updates</name>
  <files>
    app/(tabs)/dashboard.tsx
    app/(tabs)/_layout.tsx
  </files>
  <action>
**1. Update `app/(tabs)/dashboard.tsx` to be role-aware:**

The current dashboard is parent-centric (uses StudentContext with isParentView, selectedStudent, student picker). For student users, the dashboard should show a completely different layout.

Add a role check at the top:
```typescript
const { user, userRole } = useAuth();
```

Then conditionally render based on role:
- If `userRole === 'parent'`: render the existing parent dashboard exactly as-is (no changes)
- If `userRole === 'student'`: render the new student dashboard (described below)

**Student Dashboard Layout (top to bottom):**

**A. Header section** (indigo #4F46E5 background, matching parent header):
- "Hey, {firstName}!" greeting (use profile.name.split(' ')[0], encouraging tone per context decisions)
- Show streak count with fire emoji: "{streakCount} day streak" (or "Start your streak!" if 0)
- Student badge: "Student" in a pill badge (similar styling to parent's "Parent View" badge)

**B. Today's Tasks section** (immediately after header -- action-first per context decisions):
- Section title: "What You Need To Do Today"
- Two task cards in a row:
  1. **QOD card**: Shows "Question of the Day" with status indicator. If answered today: green checkmark + "Completed!" text. If not: orange dot + "Ready to answer!" text. The card itself is not tappable in this phase (Phase 3 adds the combined flow).
  2. **Behavior card**: Shows "Behavior Check-in" with status indicator. If today's assessment exists: green checkmark + "Completed!" text. If not: orange dot + "Time to reflect!" text.
- Style: white cards with rounded corners, shadow, 12px border-radius, row layout with gap: 12

**C. Horizontal scrollable metric cards** (Instagram stories style per context decisions):
- Use `FlatList` with `horizontal={true}`, `pagingEnabled={true}`, `snapToInterval={cardWidth + 12}` (12px gap), `decelerationRate="fast"`, `showsHorizontalScrollIndicator={false}`
- Card width: `Dimensions.get('window').width - 64` (32px padding on each side, allowing peek of next card)
- Four metric cards:
  1. **GPA**: Large number (gpa.toFixed(2) or "--"), subtitle "Current GPA", context line showing grade count
  2. **Earnings**: Large number (formatCurrency(totalReward)), subtitle "Total Rewards", context line showing base reward rate ("${baseAmount} per grade" -- full financial transparency per context decisions)
  3. **Streak**: Large number (streakCount), subtitle "Day Streak", context line with encouragement ("Keep it going!" or "Answer today's QOD!")
  4. **Behavior**: Large number (overallAverage.toFixed(1) or "--"), subtitle "Behavior Score", context line showing assessment count
- Each card: white background, 16px padding, 16px border-radius, shadow, large number (fontSize 36, fontWeight bold), subtitle (fontSize 12, uppercase, gray-500), context line (fontSize 14, gray-600)
- Add page indicator dots below FlatList (small circles, active = indigo-600, inactive = gray-300)

**D. Reward Structure section** (full financial transparency per context decisions):
- Section title: "Your Reward Structure"
- Show base reward amount: "$X per grade"
- Show bonus tiers earned: Education bonus (if any) + Behavior bonus (if any)
- Show allocation breakdown (same as parent view): Taxes 15%, Retirement 10%, Savings 25%, Discretionary 50% with amounts

**Data fetching for student view:**
When `userRole === 'student'`, use `user.id` directly as the studentUserId for all hooks (useStudentGrades, useBehaviorAssessments, useEducationBonus, useBehaviorBonus). For useStudentProfile, it already uses user.id.

For the student view, fetch student profile to get base_reward_amount and grade_level:
```typescript
const { profile: studentProfile } = useStudentProfile();
const baseRewardAmount = userRole === 'student'
  ? (studentProfile?.base_reward_amount || 0)
  : (selectedStudent?.base_reward_amount || 0);
```

For streak, check hasAnsweredToday from useQuestionOfTheDay hook (existing) or count from useEducationBonus.

For today's task status:
- QOD answered today: check if `question_of_day_results` has a row for today's date. Use a simple query or check from existing useQuestionOfTheDay hook.
- Behavior check-in today: `useBehaviorAssessments` already returns `todayAssessment`.

IMPORTANT: Keep the parent view code completely unchanged. Wrap the student view in a conditional. Structure:
```typescript
if (userRole === 'student') {
  return <StudentDashboardView ... />;  // Can be inline or extracted component
}
// ... existing parent dashboard code below, untouched
```

The student copy should use encouraging language per context decisions:
- "Hey, {name}!" (not "Welcome, {name}")
- "Keep it going!" for active streaks
- "Great start!" when metrics exist
- "You've got this!" when no data yet

**2. Update `app/(tabs)/_layout.tsx` for student tab visibility:**

Currently only Earnings is hidden from students. Per context decisions, students see exactly 5 tabs: Dashboard, Grades, Behavior, Learn, Settings. Parents see all 6 (Dashboard, Grades, Behavior, Learn, Earnings, Settings).

The Earnings tab is already hidden from students via `href: userRole === 'student' ? null : '/(tabs)/earnings'`. This is correct -- no additional tabs need hiding since the 5 student tabs match the remaining 5 parent tabs minus Earnings.

However, verify the tab ORDER is correct for students: Dashboard, Grades, Behavior, Learn, Settings. The current order in _layout.tsx is: Dashboard, Grades, Behavior, Learn, Earnings, Settings. When Earnings is hidden (href: null), the remaining tabs are: Dashboard, Grades, Behavior, Learn, Settings. This matches the requirement. No change needed to _layout.tsx tab order.

BUT -- the parent has screens like student-management, grade-approval, term-tracking, family-meetings accessible from settings/navigation. These are stack screens in _layout.tsx root, not tabs, so they're accessible by URL. We should NOT add explicit blocking for those in this plan (they're navigated to by parent-only buttons which students don't see). Phase 1 already established that tab visibility is the gating mechanism. No changes to _layout.tsx needed beyond confirming Earnings is hidden.

Actually -- review _layout.tsx one more time. If no tab changes are needed, remove this file from files_modified. But wait: the requirement says "Student sees a different tab bar than parent." Current state already accomplishes this via the Earnings hide. Verify by reading the 4 success criteria:
- SC3: "Student sees a different tab bar than parent (Dashboard, Grades, Behavior, Learn, Settings) with no parent management tabs visible" -- Already done by Phase 1's href:null on Earnings.
- SC4: "Parent can still switch between students and see all parent features" -- Already working.

So _layout.tsx might not need changes. But let me keep it in files_modified as a verification touchpoint. If during execution no changes are needed, the executor can note "no changes required, verified correct."
  </action>
  <verify>
- `npx tsc --noEmit` passes with zero errors
- Student dashboard renders with horizontal scrollable metric cards (FlatList horizontal)
- Parent dashboard unchanged (same visual output as before)
- Student sees "Today's Tasks" section at top with QOD and behavior status
- Student sees reward structure and allocation breakdown
- Tab bar shows 5 tabs for student, 6 for parent
  </verify>
  <done>
- Student signs in and sees personalized dashboard with horizontal metric cards (GPA, Earnings, Streak, Behavior)
- "Today's Tasks" section shows QOD and behavior check-in status at the top (action-first)
- Reward structure visible with base amount and allocation breakdown (full financial transparency)
- Student copy uses encouraging language ("Hey, {name}!", "Keep it going!", "You've got this!")
- Parent dashboard completely unchanged (same code path, same visual)
- Student tab bar: Dashboard, Grades, Behavior, Learn, Settings (5 tabs, no Earnings)
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- TypeScript compiles cleanly
2. Student login flow: sign in as student -> index.tsx checks onboarding -> if not completed, redirect to /(onboarding) (404 until Plan 03, expected) -> if completed, redirect to dashboard -> student dashboard renders with metric cards
3. Parent login flow: sign in as parent -> redirect to dashboard -> parent dashboard renders identically to before
4. Tab bar: student sees 5 tabs, parent sees 6 tabs
5. Student dashboard data: hooks fetch using user.id, display GPA/earnings/streak/behavior correctly
6. Migration file ready for manual application to Supabase
</verification>

<success_criteria>
- Student sees a personalized dashboard with horizontal scrollable metric cards showing GPA, earnings, streak, and behavior score
- "Today's Tasks" appears at the top of student dashboard (action-first design)
- Student sees full reward structure and allocation breakdown (financial transparency)
- Student tab bar shows exactly 5 tabs: Dashboard, Grades, Behavior, Learn, Settings
- Parent experience completely unchanged (dashboard, tabs, student picker, all features)
- Routing gates students on has_completed_onboarding flag (redirects to /(onboarding) if false)
- SQL migration file created for has_completed_onboarding column
- TypeScript compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-auth-student-routing/02-02-SUMMARY.md`
</output>
