---
phase: 02-auth-student-routing
plan: 03
type: execute
wave: 2
depends_on: ["02-02"]
files_modified:
  - app/(onboarding)/_layout.tsx
  - app/(onboarding)/index.tsx
  - app/(onboarding)/welcome.tsx
  - app/(onboarding)/profile.tsx
  - app/(onboarding)/how-it-works.tsx
  - app/(onboarding)/celebration.tsx
  - app/_layout.tsx
  - app/(tabs)/settings.tsx
autonomous: true

must_haves:
  truths:
    - "New student (has_completed_onboarding=false) is redirected to onboarding and cannot skip it"
    - "Onboarding starts with a welcome screen and walks through profile/settings"
    - "Onboarding includes a 'how it works' step explaining the reward system"
    - "Onboarding ends with a celebration screen before going to dashboard"
    - "After completing onboarding, has_completed_onboarding is set to true in the database"
    - "Returning student (has_completed_onboarding=true) goes straight to dashboard"
    - "Student can replay tutorial from Settings"
    - "Tutorial copy uses friendly, encouraging tone"
  artifacts:
    - path: "app/(onboarding)/_layout.tsx"
      provides: "Onboarding stack navigator"
      min_lines: 15
    - path: "app/(onboarding)/welcome.tsx"
      provides: "Welcome screen introducing the app"
      min_lines: 40
    - path: "app/(onboarding)/profile.tsx"
      provides: "Profile/settings walkthrough step"
      min_lines: 40
    - path: "app/(onboarding)/how-it-works.tsx"
      provides: "Reward system explanation step"
      min_lines: 40
    - path: "app/(onboarding)/celebration.tsx"
      provides: "Completion celebration screen"
      min_lines: 30
    - path: "app/(onboarding)/index.tsx"
      provides: "Onboarding entry point that redirects to welcome"
      min_lines: 5
    - path: "app/_layout.tsx"
      provides: "Root layout with (onboarding) route registered"
      contains: "onboarding"
    - path: "app/(tabs)/settings.tsx"
      provides: "Settings screen with Replay Tutorial button for students"
      contains: "Replay Tutorial"
  key_links:
    - from: "app/index.tsx"
      to: "app/(onboarding)/index.tsx"
      via: "Redirect href='/(onboarding)' when has_completed_onboarding is false"
      pattern: "onboarding"
    - from: "app/(onboarding)/celebration.tsx"
      to: "supabase student_profiles"
      via: "UPDATE has_completed_onboarding = true"
      pattern: "has_completed_onboarding.*true"
    - from: "app/(onboarding)/celebration.tsx"
      to: "app/(tabs)/dashboard"
      via: "router.replace after setting onboarding complete"
      pattern: "router\\.replace.*dashboard"
    - from: "app/(tabs)/settings.tsx"
      to: "app/(onboarding)/welcome.tsx"
      via: "router.push to replay tutorial"
      pattern: "onboarding"
---

<objective>
Build the required interactive onboarding tutorial for new students -- a multi-step guided experience that walks them through their account before they can access the app.

Purpose: Per locked context decisions, the onboarding tutorial is required (not skippable). All students see the same tutorial. It starts with profile/settings, explains how the reward system works, and ends with a celebration. This builds confidence and engagement before the student uses the app independently.

Output: Four onboarding screens (welcome, profile, how-it-works, celebration), route group registered in root layout, onboarding completion flag written to DB, and replay button in Settings.
</objective>

<execution_context>
@/Users/robertisrael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertisrael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-auth-student-routing/02-02-SUMMARY.md

Key files:
@app/_layout.tsx -- Root layout, needs (onboarding) route group
@app/index.tsx -- Already gates students to /(onboarding) from Plan 02
@app/(tabs)/settings.tsx -- Needs "Replay Tutorial" button for students
@src/hooks/useStudentProfile.ts -- Has has_completed_onboarding field from Plan 02
@src/contexts/AuthContext.tsx -- Provides userRole for conditional rendering
@src/integrations/supabase/client.ts -- Supabase client for DB update
@src/theme/colors.ts -- Design system colors
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create onboarding route group with 4 tutorial screens</name>
  <files>
    app/(onboarding)/_layout.tsx
    app/(onboarding)/index.tsx
    app/(onboarding)/welcome.tsx
    app/(onboarding)/profile.tsx
    app/(onboarding)/how-it-works.tsx
    app/(onboarding)/celebration.tsx
    app/_layout.tsx
  </files>
  <action>
**1. Create `app/(onboarding)/_layout.tsx`:**
- Simple Stack navigator with no headers (headerShown: false on all screens)
- Screens: index, welcome, profile, how-it-works, celebration
- gestureEnabled: false on all screens (prevent swipe-back to skip steps)
- Animation: slide_from_right for forward flow feel

```typescript
import { Stack } from 'expo-router';

export default function OnboardingLayout() {
  return (
    <Stack screenOptions={{ headerShown: false, gestureEnabled: false }}>
      <Stack.Screen name="index" />
      <Stack.Screen name="welcome" />
      <Stack.Screen name="profile" />
      <Stack.Screen name="how-it-works" />
      <Stack.Screen name="celebration" />
    </Stack>
  );
}
```

**2. Create `app/(onboarding)/index.tsx`:**
- Simple redirect to welcome screen: `<Redirect href="/(onboarding)/welcome" />`
- This is the entry point when index.tsx redirects students to /(onboarding)

**3. Create `app/(onboarding)/welcome.tsx`:**
- Full-screen welcome with encouraging tone
- Large centered content:
  - App icon area (use a large emoji or Ionicons icon for now -- a graduation cap + money combo)
  - "Welcome to Centsible Scholar!" (fontSize 28, bold, indigo-600)
  - "We're excited to have you here! Let's take a quick tour so you know how everything works." (fontSize 16, gray-600, textAlign center, 24px horizontal padding)
  - Student name personalization: "Ready, {firstName}?" (fetch from useStudentProfile or useAuth user metadata)
- Bottom: Large "Let's Go!" button (full-width, indigo-600 bg, white text, 16px padding, 12px border-radius)
- On press: `router.push('/(onboarding)/profile')`
- Progress indicator at top: Step 1 of 3 (show 3 dots, first active)
- SafeAreaView wrapper for proper insets

**4. Create `app/(onboarding)/profile.tsx`:**
- Tutorial starts with profile/settings (per context decisions: "Here's your account, you can change [X]")
- Content layout:
  - Progress indicator: Step 2 of 3 (second dot active)
  - "Your Profile" title (fontSize 24, bold)
  - Show current profile info in a card:
    - Name: "{profile.name}"
    - Grade: "Grade {profile.grade_level}"
    - Email: "{user.email}"
  - Explanatory text: "This is your account info. You can update your profile anytime in Settings." (encouraging tone)
  - Tip callout box (light indigo background, indigo border-left): "Tip: Check Settings regularly to keep your info up to date!"
- Bottom: "Next" button -> `router.push('/(onboarding)/how-it-works')`
- Use useStudentProfile() to get name, grade_level
- Use useAuth() to get user.email

**5. Create `app/(onboarding)/how-it-works.tsx`:**
- Explains the reward system (full financial transparency per context decisions)
- Content layout:
  - Progress indicator: Step 3 of 3 (third dot active)
  - "How You Earn" title (fontSize 24, bold)
  - Reward explanation cards (vertical stack):
    1. **Grades card**: Icon (school) + "Submit your grades and earn rewards! Your parent set ${baseAmount} per grade." + "Better grades = bigger rewards"
    2. **Behavior card**: Icon (star) + "Complete your daily behavior check-in to earn bonus rewards." + "Keep your score above 3.0 to qualify"
    3. **QOD card**: Icon (lightbulb) + "Answer the Question of the Day to build your streak and earn education bonuses." + "Higher accuracy = bigger bonus"
    4. **Savings card**: Icon (wallet) + "Your earnings are automatically split: Taxes (15%), Retirement (10%), Savings (25%), and Discretionary (50%)." + "Learn real-world money management!"
  - Each card: white bg, 12px border-radius, 16px padding, shadow, icon on left, text on right
  - Encouraging footer: "You've got this! Every day is a chance to earn and learn."
- Bottom: "Got it!" button -> `router.push('/(onboarding)/celebration')`
- Fetch baseRewardAmount from useStudentProfile()

**6. Create `app/(onboarding)/celebration.tsx`:**
- Full-screen celebration (per context decisions: "achievement/celebration screen")
- Centered content:
  - Large celebration visual (use party emoji combination or Ionicons trophy icon at 80px)
  - "You're All Set!" title (fontSize 32, bold, indigo-600)
  - "Great job completing the tour! You're ready to start earning and learning." (fontSize 16, gray-600, textAlign center)
  - Encouraging subtext: "Remember: check in daily for your Question of the Day and Behavior assessment. You've got this!"
- Bottom: "Go to Dashboard" button
- On press:
  1. Update database: `supabase.from('student_profiles').update({ has_completed_onboarding: true }).eq('user_id', user.id)` (use auth user ID)
  2. Invalidate React Query cache for studentProfile so the hook picks up the change
  3. Navigate: `router.replace('/(tabs)/dashboard')` (replace, not push, so back doesn't go to onboarding)
- Loading state on button while DB update in progress
- Error handling: if DB update fails, show Alert but still navigate to dashboard (don't trap student in onboarding). Log the error.

**7. Update `app/_layout.tsx`:**
- Add the (onboarding) route group to the root Stack:
```typescript
<Stack.Screen name="(onboarding)" options={{ headerShown: false }} />
```
- Place it after the (auth) screen and before the (tabs) screen in the Stack children order.

**Shared progress indicator component:**
Create an inline or local component for the 3-dot progress indicator used across welcome, profile, and how-it-works:
```typescript
function ProgressDots({ current, total }: { current: number; total: number }) {
  return (
    <View style={{ flexDirection: 'row', justifyContent: 'center', gap: 8, marginBottom: 24 }}>
      {Array.from({ length: total }).map((_, i) => (
        <View key={i} style={{
          width: 10, height: 10, borderRadius: 5,
          backgroundColor: i < current ? '#4F46E5' : '#D1D5DB',
        }} />
      ))}
    </View>
  );
}
```
Put this in each screen file that needs it (welcome, profile, how-it-works). Do NOT create a shared component file -- keeping it local avoids cross-file dependencies for a simple UI element.

**Styling guidelines for all onboarding screens:**
- White background (#ffffff)
- SafeAreaView wrapper
- Content centered vertically with padding: 24
- Button at bottom: position absolute or flex layout that pushes button to bottom
- Use `KeyboardAvoidingView` only if there are inputs (only profile might have them, but profile is read-only in this phase)
- Consistent with existing auth screen patterns but more visually engaging (larger text, more spacing, encouraging copy)
- All copy uses friendly, encouraging tone per context decisions: "Great job!", "You've got this!", "Let's Go!"
  </action>
  <verify>
- `npx tsc --noEmit` passes with zero errors
- All 6 onboarding files exist (layout, index, welcome, profile, how-it-works, celebration)
- Root _layout.tsx includes (onboarding) route
- celebration.tsx updates has_completed_onboarding in database
- celebration.tsx uses router.replace to navigate to dashboard (not push)
  </verify>
  <done>
- Onboarding route group exists with 4 content screens + layout + index redirect
- Welcome screen shows personalized greeting with "Let's Go!" CTA
- Profile screen shows student's account info with settings tip
- How-it-works screen explains rewards, grades, behavior, QOD, and allocation breakdown
- Celebration screen congratulates student and updates has_completed_onboarding to true
- Root layout registers the onboarding route group
- Navigation flow: welcome -> profile -> how-it-works -> celebration -> dashboard
- Back gesture disabled (cannot skip steps)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add "Replay Tutorial" button to Settings for students</name>
  <files>
    app/(tabs)/settings.tsx
  </files>
  <action>
Update the Settings screen to show a "Replay Tutorial" button for student users:

1. Import `useAuth` (may already be imported) and get `userRole`
2. Add a conditional section visible only when `userRole === 'student'`:
   - Place it in a logical position within settings (after profile section, before any danger zone/logout)
   - Section or standalone button: "Replay Tutorial" with a refresh/replay icon (Ionicons "refresh-outline" or "play-outline")
   - Style: same as other settings action buttons/rows in the existing file
   - On press: `router.push('/(onboarding)/welcome')` (push, not replace, so they can come back to settings)
   - Note: when replaying, the onboarding will NOT re-write has_completed_onboarding since it's already true, and the celebration screen will just update it to true again (idempotent). This is fine.

3. Read the existing settings.tsx first to understand its structure and match the styling exactly. The button should look native to the existing settings UI, not stand out as an afterthought.

4. The button should use encouraging language consistent with student copy: "Replay Tutorial" with subtitle "Review how everything works" (or similar, matching existing settings item patterns).

IMPORTANT: Only add the replay button. Do not modify any other settings functionality. Do not hide any parent-only settings from students in this plan (that's already handled by navigation -- students can't navigate to student-management etc. because those links only appear in parent UI).
  </action>
  <verify>
- `npx tsc --noEmit` passes with zero errors
- Settings screen conditionally shows "Replay Tutorial" for student role only
- Tapping "Replay Tutorial" navigates to onboarding welcome screen
- Parent settings screen unchanged (no replay button visible)
  </verify>
  <done>
- Student sees "Replay Tutorial" option in Settings
- Parent does not see "Replay Tutorial" option
- Tapping navigates to /(onboarding)/welcome for a full replay
- Settings screen otherwise unchanged for both roles
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- TypeScript compiles cleanly
2. Full onboarding flow: new student (has_completed_onboarding=false) -> redirected to /(onboarding) -> welcome -> profile -> how-it-works -> celebration -> has_completed_onboarding set to true -> redirected to dashboard
3. Return visit: student with has_completed_onboarding=true -> goes straight to dashboard (no onboarding)
4. Replay: student opens Settings -> taps "Replay Tutorial" -> sees onboarding screens again -> celebration -> back to dashboard
5. Parent: no onboarding gate, no replay button, everything works as before
6. Back gesture disabled throughout onboarding (cannot skip)
7. All copy uses encouraging, friendly tone
</verification>

<success_criteria>
- New students MUST complete onboarding before accessing the app (not skippable)
- Onboarding flow: welcome -> profile/settings overview -> how-it-works (rewards) -> celebration
- Celebration screen updates has_completed_onboarding=true in student_profiles
- Returning students skip onboarding and go to dashboard
- "Replay Tutorial" available in student Settings
- All tutorial screens use encouraging, friendly copy ("Great job!", "You've got this!")
- Parent experience completely unaffected
- TypeScript compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-auth-student-routing/02-03-SUMMARY.md`
</output>
