---
phase: 02-auth-student-routing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/(auth)/login.tsx
  - app/(auth)/forgot-password.tsx
  - app/(auth)/verify-reset-code.tsx
  - app/(auth)/reset-password.tsx
  - app/(auth)/_layout.tsx
autonomous: true

must_haves:
  truths:
    - "User sees 'Forgot Password?' link on the login screen"
    - "Tapping 'Forgot Password?' navigates to an email input screen"
    - "Entering a valid email and tapping Send sends a 6-digit OTP via Supabase"
    - "User can enter the 6-digit code on a verification screen"
    - "After valid code, user can set a new password"
    - "After password reset, user is signed in and redirected to dashboard"
    - "Invalid/expired code shows an error message"
  artifacts:
    - path: "app/(auth)/forgot-password.tsx"
      provides: "Email input screen for password reset"
      min_lines: 40
    - path: "app/(auth)/verify-reset-code.tsx"
      provides: "OTP code entry + new password screen"
      min_lines: 60
    - path: "app/(auth)/login.tsx"
      provides: "Updated login with Forgot Password link"
      contains: "forgot-password"
    - path: "app/(auth)/_layout.tsx"
      provides: "Stack routes for new auth screens"
      contains: "forgot-password"
  key_links:
    - from: "app/(auth)/login.tsx"
      to: "app/(auth)/forgot-password.tsx"
      via: "router.push('/(auth)/forgot-password')"
      pattern: "forgot-password"
    - from: "app/(auth)/forgot-password.tsx"
      to: "supabase.auth.resetPasswordForEmail"
      via: "Supabase auth API call"
      pattern: "resetPasswordForEmail"
    - from: "app/(auth)/verify-reset-code.tsx"
      to: "supabase.auth.verifyOtp"
      via: "OTP verification creating session"
      pattern: "verifyOtp.*recovery"
    - from: "app/(auth)/verify-reset-code.tsx"
      to: "supabase.auth.updateUser"
      via: "Password update after OTP verification"
      pattern: "updateUser.*password"
---

<objective>
Add complete OTP-based password reset flow to the authentication system.

Purpose: Users who forget their password can recover their account without contacting support. This is AUTH-04 and a prerequisite for independent student login (students need password recovery too).

Output: Three new auth screens (email input, code verification + password reset) and updated login screen with "Forgot Password?" link.
</objective>

<execution_context>
@/Users/robertisrael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertisrael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Key files:
@app/(auth)/login.tsx -- Current login screen, needs "Forgot Password?" link added
@app/(auth)/_layout.tsx -- Auth stack layout, needs new screen routes
@src/integrations/supabase/client.ts -- Supabase client with auth helpers
@src/theme/colors.ts -- Design system colors
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create password reset screens (email input + OTP verification)</name>
  <files>
    app/(auth)/forgot-password.tsx
    app/(auth)/verify-reset-code.tsx
    app/(auth)/_layout.tsx
  </files>
  <action>
Create two new screens in the auth group:

**app/(auth)/forgot-password.tsx:**
- Email input field with "Enter your email address" label
- "Send Reset Code" button that calls `supabase.auth.resetPasswordForEmail(email)`
- Loading state on the button while sending
- On success: show brief confirmation ("Check your email for a 6-digit code"), then navigate to verify-reset-code screen, passing email as a route param via `router.push({ pathname: '/(auth)/verify-reset-code', params: { email } })`
- On error: show Alert with error message
- Back button/link to return to login
- Match existing auth screen styling (see login.tsx: white background, #4F46E5 primary, same input styles, KeyboardAvoidingView wrapper)
- Add helper text below the email field: "We'll send a 6-digit code to this email address"

**app/(auth)/verify-reset-code.tsx:**
- Read `email` from route params using `useLocalSearchParams()`
- Show "Enter the 6-digit code sent to {email}" header text
- 6-digit code input field (TextInput with keyboardType="number-pad", maxLength 6, textContentType="oneTimeCode" for iOS autofill from SMS/email)
- New password field (secureTextEntry, minLength 6 validation)
- Confirm password field (must match new password)
- "Reset Password" button that:
  1. Calls `supabase.auth.verifyOtp({ email, token: code, type: 'recovery' })` -- this creates an authenticated session
  2. On OTP success, immediately calls `supabase.auth.updateUser({ password: newPassword })`
  3. On complete success: show success Alert ("Password updated successfully!"), then `router.replace('/(tabs)/dashboard')` (user is already logged in from verifyOtp)
  4. On OTP failure: show error ("Invalid or expired code. Please try again.")
  5. On password update failure: show error with message
- Loading state on the submit button
- "Didn't receive a code? Send again" link at bottom that calls resetPasswordForEmail again and shows a toast/Alert "Code resent!"
- Match existing auth screen styling

**app/(auth)/_layout.tsx:**
- Add Stack.Screen entries for "forgot-password" and "verify-reset-code"
- forgot-password: title "Forgot Password", headerShown false (consistent with login/signup)
- verify-reset-code: title "Reset Password", headerShown false

IMPORTANT: Use `textContentType="oneTimeCode"` on the OTP input (prevents iOS password autofill overlay, learned from Phase 1). Do NOT use secureTextEntry on the OTP input.
  </action>
  <verify>
- `npx tsc --noEmit` passes with zero errors
- All three files exist and export default components
- `_layout.tsx` includes routes for both new screens
  </verify>
  <done>
- forgot-password screen renders with email input and send button
- verify-reset-code screen renders with code input, password fields, and submit button
- Auth stack layout includes both new screen routes
  </done>
</task>

<task type="auto">
  <name>Task 2: Add "Forgot Password?" link to login screen</name>
  <files>
    app/(auth)/login.tsx
  </files>
  <action>
Update the existing login screen to include a "Forgot Password?" link:

- Add a TouchableOpacity with text "Forgot Password?" positioned below the password input field and above the "Sign In" button
- On press: `router.push('/(auth)/forgot-password')`
- Style: text color #4F46E5 (primary indigo), fontSize 14, fontWeight '500', alignSelf 'flex-end' (right-aligned, standard mobile pattern)
- Add marginTop: 4 to the forgot password link, marginBottom: 8 to separate from the sign in button

The link goes between the password inputContainer and the sign-in button inside the form View. Add the TouchableOpacity after the password `</View>` (inputContainer closing) and before the sign-in `<TouchableOpacity>`.
  </action>
  <verify>
- `npx tsc --noEmit` passes with zero errors
- login.tsx contains "Forgot Password?" text and router.push to forgot-password route
  </verify>
  <done>
- Login screen shows "Forgot Password?" link below the password field
- Tapping it navigates to the forgot-password screen
- Existing login functionality (email/password sign in, sign up link) unchanged
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- TypeScript compiles cleanly
2. Manual trace: login.tsx "Forgot Password?" -> navigates to forgot-password.tsx -> email input -> calls resetPasswordForEmail -> navigates to verify-reset-code.tsx -> code + password inputs -> calls verifyOtp then updateUser -> redirects to dashboard
3. All Supabase auth methods used correctly: resetPasswordForEmail (sends OTP), verifyOtp with type 'recovery' (validates code + creates session), updateUser (sets new password)
4. Error handling on every API call with user-facing messages
</verification>

<success_criteria>
- "Forgot Password?" link visible on login screen and navigates to email input screen
- Email input screen calls Supabase resetPasswordForEmail and navigates to code verification
- Code verification screen validates OTP via verifyOtp, updates password via updateUser, and redirects authenticated user to dashboard
- All screens match existing auth styling (white bg, indigo primary, consistent inputs)
- TypeScript compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-auth-student-routing/02-01-SUMMARY.md`
</output>
