---
phase: 01-architecture-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/contexts/AuthContext.tsx
  - app/index.tsx
  - app/(tabs)/_layout.tsx
autonomous: true

must_haves:
  truths:
    - "Parent user logs in and is routed to /(tabs)/dashboard"
    - "Student user logs in and is routed to /(tabs)/dashboard (same destination, different tab visibility)"
    - "Student does not see Earnings tab or any parent management screens in the tab bar"
    - "Parent sees all 6 tabs (Dashboard, Grades, Behavior, Learn, Earnings, Settings)"
    - "Student sees 5 tabs (Dashboard, Grades, Behavior, Learn, Settings) with Earnings hidden"
    - "If user_metadata.user_type is missing or invalid, user is signed out with an error"
    - "Existing parent login and dashboard continue to work exactly as before"
  artifacts:
    - path: "src/contexts/AuthContext.tsx"
      provides: "Role detection from user_metadata.user_type, cached in context state"
      exports: ["useAuth", "AuthProvider"]
      contains: "userRole"
    - path: "app/index.tsx"
      provides: "Role-aware routing on auth state"
      contains: "userRole"
    - path: "app/(tabs)/_layout.tsx"
      provides: "Conditional tab visibility based on role"
      contains: "href: null"
  key_links:
    - from: "src/contexts/AuthContext.tsx"
      to: "supabase.auth.getSession"
      via: "user_metadata.user_type extraction"
      pattern: "user_metadata.*user_type"
    - from: "app/index.tsx"
      to: "src/contexts/AuthContext.tsx"
      via: "useAuth() hook consuming userRole"
      pattern: "useAuth.*userRole"
    - from: "app/(tabs)/_layout.tsx"
      to: "src/contexts/AuthContext.tsx"
      via: "useAuth() hook for conditional tab rendering"
      pattern: "href.*null"
---

<objective>
Add role detection to AuthContext and implement role-based routing with conditional tab visibility so parents and students see the correct experience.

Purpose: This is the foundational role infrastructure that gates all downstream student-specific features (Phase 2-3) and parent-only screen protection. Without role detection in the auth layer, no downstream phase can distinguish parent from student.

Output: AuthContext exposes `userRole: 'parent' | 'student' | null`, app/index.tsx routes by role, and the tab bar hides parent-only tabs from students.
</objective>

<execution_context>
@/Users/robertisrael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertisrael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-architecture-foundation/01-CONTEXT.md
@src/contexts/AuthContext.tsx
@src/contexts/StudentContext.tsx
@app/index.tsx
@app/(tabs)/_layout.tsx
@app/_layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add role detection to AuthContext</name>
  <files>src/contexts/AuthContext.tsx</files>
  <action>
Extend the existing AuthContext to detect and expose the user's role:

1. Add `userRole: 'parent' | 'student' | null` to the `AuthContextType` interface. Default to `null` when no user is logged in.

2. Add `signOutWithError: (message: string) => Promise<void>` to AuthContextType -- a helper that signs the user out and shows an Alert with the error message. This is used when role validation fails.

3. In the AuthProvider, add state: `const [userRole, setUserRole] = useState<'parent' | 'student' | null>(null)`

4. Create a helper function `extractRole(user: User | null)` that:
   - If user is null, return null
   - Reads `user.user_metadata?.user_type`
   - If value is 'parent' or 'student', return it
   - If value is missing or any other value, this is a data integrity issue

5. In `initializeAuth()` after getting the session, extract role:
   ```
   const role = extractRole(initialSession?.user ?? null);
   setUserRole(role);
   ```
   If role extraction finds an invalid/missing user_type AND there IS a user (session exists), call signOutWithError.

6. In the `onAuthStateChange` callback, do the same:
   ```
   const role = extractRole(newSession?.user ?? null);
   setUserRole(role);
   ```
   If the event is 'SIGNED_IN' and role is invalid, call signOutWithError.

7. When user signs out (event is 'SIGNED_OUT'), set userRole to null.

8. Add `userRole` and `signOutWithError` to the context value.

IMPORTANT: The `signOutWithError` function should:
- Call `await supabase.auth.signOut()`
- Show `Alert.alert('Account Error', message)`
- The error message for invalid role: "Your account is missing role information. Please contact support."

IMPORTANT: Import Alert from 'react-native' and signOut helper or call supabase.auth.signOut() directly.

Do NOT change the existing `user`, `session`, or `loading` state behavior. Only ADD the new role functionality.
  </action>
  <verify>
Run `npx tsc --noEmit` from the project root. No type errors related to AuthContext.
Verify that `useAuth()` now returns `{ user, session, loading, userRole, signOutWithError }` by checking the interface.
  </verify>
  <done>
AuthContext exposes userRole ('parent' | 'student' | null) extracted from user_metadata.user_type on every auth state change. Invalid roles trigger sign-out with error alert. Existing auth behavior (user, session, loading) unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Role-based routing and conditional tab visibility</name>
  <files>app/index.tsx, app/(tabs)/_layout.tsx</files>
  <action>
**app/index.tsx changes:**

Update the root index to be role-aware:

1. Import `useAuth` (already imported) and read `userRole` in addition to `user` and `loading`:
   ```
   const { user, loading, userRole } = useAuth();
   ```

2. Keep the existing loading spinner for the `loading` state.

3. When user exists but userRole is null, this means role extraction failed and signOutWithError was called (or is in progress). Show the loading spinner in this case too to avoid a flash -- the auth state change to SIGNED_OUT will redirect to login.

4. Route logic:
   - If no user: `<Redirect href="/(auth)/login" />`
   - If user AND userRole is 'parent': `<Redirect href="/(tabs)/dashboard" />`
   - If user AND userRole is 'student': `<Redirect href="/(tabs)/dashboard" />` (same destination for now; Phase 2 adds student welcome screen)
   - If user AND userRole is null: show loading spinner (signout in progress)

Note: Both parent and student go to /(tabs)/dashboard for now. The differentiation happens in tab visibility below. Phase 2 will add the student welcome/onboarding screen.

**app/(tabs)/_layout.tsx changes:**

Make tab visibility conditional on role:

1. Import `useAuth` from `../../src/contexts/AuthContext`:
   ```
   import { useAuth } from '../../src/contexts/AuthContext';
   ```

2. Inside `TabLayout`, get the role:
   ```
   const { userRole } = useAuth();
   ```

3. For the "earnings" tab, conditionally hide it from students using Expo Router's `href: null` pattern:
   ```
   <Tabs.Screen
     name="earnings"
     options={{
       title: 'Earnings',
       href: userRole === 'student' ? null : '/(tabs)/earnings',
       tabBarIcon: ...
     }}
   />
   ```

   Note: `href: null` tells Expo Router to keep the screen in the navigation stack but hide it from the tab bar. This is the recommended approach from Expo docs for conditional tab visibility.

4. The following tabs are visible to ALL users (parent and student): Dashboard, Grades, Behavior, Learn, Settings. Do NOT modify these.

5. Only Earnings is hidden from students. The parent management screens (student-management, grade-approval, family-meetings, term-tracking) are Stack screens in _layout.tsx, not tabs, and are already gated in the Settings screen via `isParent` checks. Those will be further protected in Phase 2.

IMPORTANT: Do NOT add `href` to tabs that should always be visible. Only add `href` to the earnings tab to conditionally hide it.
  </action>
  <verify>
Run `npx tsc --noEmit` from the project root. No type errors.
Run `npx expo start` and verify the app launches without crashes.
Manually verify (or log) that:
- A parent user sees 6 tabs including Earnings
- The routing logic in index.tsx references userRole
  </verify>
  <done>
app/index.tsx routes users based on role from AuthContext. app/(tabs)/_layout.tsx hides Earnings tab from student users via href: null. Parent experience unchanged -- still sees all 6 tabs.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. App starts without crashes: `npx expo start`
3. AuthContext interface includes userRole and signOutWithError
4. app/index.tsx reads userRole from useAuth()
5. app/(tabs)/_layout.tsx conditionally sets href: null on earnings tab based on role
6. No changes to existing user, session, or loading behavior in AuthContext
</verification>

<success_criteria>
- AuthContext exposes userRole derived from user_metadata.user_type
- Invalid/missing role triggers sign-out with error alert
- Root routing is role-aware (both roles route to dashboard for now)
- Student tab bar shows 5 tabs (Earnings hidden)
- Parent tab bar shows 6 tabs (all visible, unchanged from current behavior)
- TypeScript compiles cleanly
- Existing parent login flow works exactly as before
</success_criteria>

<output>
After completion, create `.planning/phases/01-architecture-foundation/01-01-SUMMARY.md`
</output>
