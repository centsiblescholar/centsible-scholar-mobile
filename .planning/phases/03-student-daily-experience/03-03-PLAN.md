---
phase: 03-student-daily-experience
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useParentQODStats.ts
  - app/(tabs)/learn.tsx
autonomous: true

must_haves:
  truths:
    - "Parent can view family-wide QOD progress with total XP, average accuracy, active streaks"
    - "Parent sees per-student progress cards in horizontal scroll format"
    - "Per-student cards show name, streak, accuracy percentage, last answer date, total QOD count"
    - "Parent can toggle time range: This Week / This Month / All Time"
    - "Accuracy displayed with color coding (green >90%, yellow 75-90%, red <75%)"
    - "Student still sees the existing QOD/Learn screen (no change to student experience)"
    - "XP display shows level number and title from level system"
  artifacts:
    - path: "src/hooks/useParentQODStats.ts"
      provides: "Parent QOD stats hook with per-student stats and family aggregates"
      exports: ["useParentQODStats"]
    - path: "app/(tabs)/learn.tsx"
      provides: "Role-conditional Learn screen: parent sees progress dashboard, student sees existing QOD"
  key_links:
    - from: "src/hooks/useParentQODStats.ts"
      to: "supabase parent_student_relationships + student_profiles + question_of_day_results"
      via: "Three-table join: relationships -> profiles -> results"
      pattern: "supabase.*from.*parent_student_relationships|student_profiles|question_of_day_results"
    - from: "app/(tabs)/learn.tsx"
      to: "src/hooks/useParentQODStats.ts"
      via: "hook call in parent branch"
      pattern: "useParentQODStats"
    - from: "app/(tabs)/learn.tsx"
      to: "useAuth userRole check"
      via: "role-conditional rendering"
      pattern: "userRole.*parent"
---

<objective>
Build the parent QOD progress dashboard showing family-wide education stats and per-student progress cards, integrated into the existing Learn tab.

Purpose: Parents need a single view to monitor their children's daily engagement with QOD questions. This replaces the single-student QOD view with a family-wide dashboard when the user is a parent.

Output: New `useParentQODStats` hook ported from web app, and updated `learn.tsx` with role-conditional rendering (parent sees progress dashboard, student sees existing QOD screen).
</objective>

<execution_context>
@/Users/robertisrael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertisrael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useParentQODStats hook with time range filtering</name>
  <files>
    src/hooks/useParentQODStats.ts
  </files>
  <action>
    Port from web app at `/Users/robertisrael/Documents/GitHub/centsible-scholar-premium/src/hooks/useParentQODStats.ts` with these adaptations:

    **Changes from web version:**
    1. Import supabase from `'../integrations/supabase/client'` (not `'@/integrations/supabase/client'`)
    2. Import useAuth from `'../contexts/AuthContext'` (not `'@/contexts/AuthContext'`)
    3. Use `@tanstack/react-query` (useQuery) instead of manual useState/useEffect pattern
    4. Add `timeRange` parameter: `'week' | 'month' | 'all'` (default: `'all'`)
    5. Include `timeRange` in query key for proper cache invalidation: `['parentQODStats', userId, timeRange]`
    6. Use `date-fns` for date calculations (already installed): `startOfWeek`, `endOfWeek`, `subWeeks`, `subMonths`, `format`

    **Interface (matching web with additions):**
    ```typescript
    export interface StudentQODStats {
      studentId: string;          // profile ID
      studentUserId: string;      // auth user ID
      studentName: string;
      gradeLevel: string;
      // Per-student stats (filtered by timeRange)
      percentage: number;         // accuracy percentage for selected range
      totalAttempts: number;      // QOD attempts in range
      correctAnswers: number;     // correct answers in range
      // Streaks (always all-time from profile)
      currentStreak: number;
      longestStreak: number;
      // XP (always all-time from profile)
      totalXP: number;
      // Today
      answeredToday: boolean;
      todayCorrect: boolean | null;
      // Meta
      lastAnswerDate: string | null;  // most recent QOD date
    }
    ```

    **Query function logic:**
    1. Get parent's student user IDs from `parent_student_relationships` where `parent_user_id = user.id`
    2. Get student profiles: `student_profiles` where `user_id IN (studentUserIds)` and `is_active = true`, selecting `id, user_id, name, grade_level, streak_count, longest_streak, total_xp, last_qod_date`
    3. Calculate date range based on `timeRange`:
       - `'week'`: from `startOfWeek(new Date(), { weekStartsOn: 1 })` to today
       - `'month'`: from `subMonths(new Date(), 1)` to today (last 30 days, not calendar month)
       - `'all'`: from 18 weeks ago to today (matching web app term length)
    4. Get QOD results: `question_of_day_results` where `user_id IN (studentUserIds)` and `date >= rangeStart` and `date <= today`
    5. Process per-student stats (matching web app logic): filter results by student, calculate accuracy, find today's result
    6. For `lastAnswerDate`: find the most recent `date` from the student's results

    **Aggregate stats (computed from studentStats, not separate queries):**
    ```typescript
    familyTotalXP: number;              // sum of all students' totalXP
    familyAveragePercentage: number;    // average of all students' percentage
    studentsWithActiveStreak: number;   // count where currentStreak > 0
    studentsAnsweredToday: number;      // count where answeredToday === true
    totalStudents: number;              // total student count
    ```

    **Return shape:**
    ```typescript
    {
      studentStats: StudentQODStats[];
      isLoading: boolean;
      error: Error | null;
      refetch: () => void;
      // Aggregates
      familyTotalXP: number;
      familyAveragePercentage: number;
      studentsWithActiveStreak: number;
      studentsAnsweredToday: number;
      totalStudents: number;
    }
    ```

    Use `staleTime: 2 * 60 * 1000` (2 minutes).
    Sort students alphabetically by name (matching CONTEXT.md decision).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `src/hooks/useParentQODStats.ts` exists
    - Exports `useParentQODStats` function and `StudentQODStats` interface
    - Query key includes timeRange: `['parentQODStats', userId, timeRange]`
    - Uses @tanstack/react-query (not manual useState/useEffect)
    - Imports date-fns functions for date calculations
  </verify>
  <done>useParentQODStats hook created with time-range filtering (week/month/all), per-student stats, and family aggregate calculations. Query key includes timeRange for proper cache invalidation.</done>
</task>

<task type="auto">
  <name>Task 2: Update Learn tab with role-conditional parent progress dashboard</name>
  <files>
    app/(tabs)/learn.tsx
  </files>
  <action>
    Restructure `learn.tsx` to show different content based on user role:
    - **Parent**: Family QOD progress dashboard (new)
    - **Student**: Existing QOD answer screen (unchanged, keep all current code)

    **At the top of the default export:**
    ```typescript
    export default function LearnScreen() {
      const { userRole } = useAuth();

      if (userRole === 'parent') {
        return <ParentQODProgressView />;
      }

      return <StudentLearnView />;
    }
    ```

    **Move ALL existing learn.tsx content into `StudentLearnView` function component** (same file). This preserves the student experience exactly as-is.

    **Create `ParentQODProgressView` component** (same file):

    Layout structure (top to bottom in a ScrollView):

    **A. Header:**
    - Purple header matching app theme (#4F46E5 background)
    - Title: "Learning Progress"
    - Subtitle: "Family QOD Dashboard"

    **B. Time Range Toggle:**
    - Segmented control matching the pattern from `behavior.tsx` tab toggle (pillbox with active state)
    - Three options: "This Week" | "This Month" | "All Time"
    - Default to "All Time"
    - State: `const [timeRange, setTimeRange] = useState<'week' | 'month' | 'all'>('all');`
    - Pass timeRange to `useParentQODStats(timeRange)`

    **C. Family Aggregate Stats Row:**
    Four stat cards in a 2x2 grid:
    1. **Total XP**: `familyTotalXP` with level info from `calculateLevelInfo(familyTotalXP)` -- show "Level {N}" and title
       - Import `calculateLevelInfo` from `../../src/utils/levelSystem`
    2. **Avg Accuracy**: `familyAveragePercentage`% with color coding:
       - Green (#10B981) if >90%
       - Yellow (#F59E0B) if 75-90%
       - Red (#EF4444) if <75%
    3. **Active Streaks**: `studentsWithActiveStreak` / `totalStudents` format ("2/3 students")
    4. **Today**: `studentsAnsweredToday` / `totalStudents` format ("1/3 answered")

    **D. Per-Student Progress Cards (horizontal scroll):**
    - Section title: "Student Progress"
    - FlatList with `horizontal`, `snapToInterval`, `decelerationRate="fast"` matching the dashboard metric cards pattern
    - Card width: screen width - 64px (same as dashboard metric cards)
    - Each card shows:
      - Student name (bold, top)
      - Streak: fire emoji + number ("7 days") or "No streak" if 0
      - Accuracy: percentage with color coding (same green/yellow/red as above)
      - Last Answer: formatted date ("Feb 5") or "Never" if null
      - Total Answered: "{N} questions" count
      - Today's status: green checkmark if answeredToday, yellow dot if not
    - Page indicator dots below the FlatList (matching dashboard pattern)
    - Cards are NOT tappable (CONTEXT says "Tapping a student card opens that student's main profile/dashboard view" but this requires deep navigation that's out of scope -- defer to Phase 6 polish)

    **E. Empty State:**
    If no students: "No students found. Add students from your dashboard."

    **F. Loading State:**
    ActivityIndicator with "Loading progress..." text

    **G. Error State:**
    Red-tinted card with error message and "Tap to retry" button calling refetch

    **Styles:**
    - Reuse existing app color palette (#4F46E5 indigo, #10B981 green, #F59E0B yellow, #EF4444 red)
    - Card style matching existing dashboard cards (white bg, rounded corners, shadow)
    - Consistent with rest of app -- no new design patterns
    - Add RefreshControl for pull-to-refresh calling refetch
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `app/(tabs)/learn.tsx` checks `userRole` and renders different views
    - Parent view uses `useParentQODStats(timeRange)` with time range toggle
    - Parent view shows aggregate stats (total XP, avg accuracy, active streaks, today count)
    - Parent view shows horizontal scrollable per-student cards
    - Student view is unchanged from before (all existing QOD code preserved)
    - `calculateLevelInfo` imported from level system utility
    - Accuracy color coding: green >90%, yellow 75-90%, red <75%
  </verify>
  <done>Learn tab shows family QOD progress dashboard for parents with aggregate stats, time range filter, and per-student horizontal scroll cards. Student QOD experience unchanged.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- Parent sees "Learning Progress" dashboard in Learn tab with aggregate stats
- Student sees existing QOD answer screen in Learn tab (no change)
- Time range toggle changes displayed stats (query key includes timeRange)
- Per-student cards show streak, accuracy, last answer date, total count
- Accuracy uses color coding (green/yellow/red thresholds)
- XP displays with level info from levelSystem utility
- Horizontal scroll with snap-to-interval and page dots matches dashboard pattern
- Empty, loading, and error states handled
</verification>

<success_criteria>
- Parent can view family-wide QOD progress in Learn tab
- Aggregate stats show total XP with level, average accuracy, active streaks, today's participation
- Per-student cards display in horizontal swipeable scroll
- Time range filter works (This Week / This Month / All Time) with proper cache invalidation
- Accuracy has color coding at correct thresholds
- Student Learn screen is completely unchanged
- Pull-to-refresh works on parent view
</success_criteria>

<output>
After completion, create `.planning/phases/03-student-daily-experience/03-03-SUMMARY.md`
</output>
