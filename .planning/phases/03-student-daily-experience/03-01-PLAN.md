---
phase: 03-student-daily-experience
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/utils/levelSystem.ts
  - src/utils/questionOfTheDayApi.ts
  - src/hooks/useQuestionOfTheDay.ts
  - src/hooks/useStudentProfile.ts
autonomous: true

must_haves:
  truths:
    - "QOD answer submission updates streak count in student_profiles"
    - "QOD answer submission awards XP (base 10 + 5 correct bonus + milestone bonuses)"
    - "Streak resets to 1 if student missed a day, increments if consecutive"
    - "XP transactions are recorded in xp_transactions table"
    - "XP/streak failures do not block QOD answer saving (fire-and-forget with try/catch)"
  artifacts:
    - path: "src/utils/levelSystem.ts"
      provides: "XP level calculation (10 levels with titles and thresholds)"
      exports: ["calculateLevelInfo", "getLevel", "getLevelTitle", "checkLevelUp", "LEVEL_THRESHOLDS"]
    - path: "src/utils/questionOfTheDayApi.ts"
      provides: "Streak calculation, XP reward calculation, streak/XP DB operations"
      exports: ["calculateStreak", "getStreakData", "updateStreakData", "calculateXPReward", "awardXP"]
    - path: "src/hooks/useQuestionOfTheDay.ts"
      provides: "Enhanced QOD hook with XP/streak side-effects after answer submission"
    - path: "src/hooks/useStudentProfile.ts"
      provides: "StudentProfile with streak_count, longest_streak, total_xp, last_qod_date fields"
  key_links:
    - from: "src/hooks/useQuestionOfTheDay.ts"
      to: "src/utils/questionOfTheDayApi.ts"
      via: "import and call after QOD save"
      pattern: "getStreakData|calculateStreak|updateStreakData|calculateXPReward|awardXP"
    - from: "src/utils/questionOfTheDayApi.ts"
      to: "supabase student_profiles"
      via: "select/update streak_count, longest_streak, total_xp, last_qod_date"
      pattern: "supabase.*from.*student_profiles"
---

<objective>
Port XP/streak/level business logic from web app and enhance the mobile QOD hook to award XP and update streaks after answer submission.

Purpose: The mobile QOD hook currently saves answers but never updates streaks or awards XP. The web app does both. This plan closes that gap by porting the pure-JS utility functions verbatim and wiring them into the existing mobile hook.

Output: Two new utility files (levelSystem.ts, questionOfTheDayApi.ts), an enhanced useQuestionOfTheDay hook, and an updated StudentProfile interface with XP/streak fields.
</objective>

<execution_context>
@/Users/robertisrael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertisrael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Port level system and streak/XP utilities from web app</name>
  <files>
    src/utils/levelSystem.ts
    src/utils/questionOfTheDayApi.ts
    src/hooks/useStudentProfile.ts
  </files>
  <action>
    **1. Create `src/utils/levelSystem.ts`:**
    Copy VERBATIM from web app at `/Users/robertisrael/Documents/GitHub/centsible-scholar-premium/src/utils/levelSystem.ts`. This is pure TypeScript with zero web dependencies. No changes needed. Exports: `calculateLevelInfo`, `getLevel`, `getLevelTitle`, `checkLevelUp`, `getLevelColors`, `LEVEL_THRESHOLDS`, `LevelInfo`, `LevelThreshold`.

    **2. Create `src/utils/questionOfTheDayApi.ts`:**
    Port from web app at `/Users/robertisrael/Documents/GitHub/centsible-scholar-premium/src/utils/questionOfTheDayApi.ts`. Changes required:
    - Change import from `import { supabase } from '@/integrations/supabase/client'` to `import { supabase } from '../integrations/supabase/client'`
    - ONLY port these functions: `calculateStreak`, `getStreakData`, `updateStreakData`, `calculateXPReward`, `awardXP`
    - Also port the interfaces: `StreakData`, `XPAward`
    - DO NOT port: `fetchTodayResult`, `fetchWeeklyStats`, `fetchTermStats`, `saveQuestionResult` (these are handled by the existing mobile hook)
    - Remove all `console.log` calls (they are debug logging in the web version)
    - IMPORTANT: The web app's `getStreakData` and `updateStreakData` query by `.eq('id', studentId)` (profile ID). For the mobile version, these MUST query by `.eq('user_id', studentId)` instead, because the mobile hooks pass `user.id` (auth user ID), not the profile row ID. The mobile `useStudentProfile` fetches by `user_id`, and the student's auth `user.id` is what's available in the QOD hook. Also add email fallback for `getStreakData` (matching the pattern in `useStudentProfile.ts` where if user_id lookup fails, try email).
    - For `awardXP`: Change `.eq('id', studentId)` to `.eq('user_id', studentId)` for the same reason. The `student_id` field in xp_transactions insert should use the profile ID -- but since we may not have it, pass `studentId` (user_id) for both `user_id` and `student_id` fields. The important thing is the XP gets recorded.

    **3. Update `src/hooks/useStudentProfile.ts`:**
    Add XP/streak fields to the `StudentProfile` interface:
    ```typescript
    export interface StudentProfile {
      id: string;
      user_id: string;
      name: string;
      email: string | null;
      grade_level: string;
      base_reward_amount: number;
      is_active: boolean;
      reporting_frequency: string;
      has_completed_onboarding: boolean;
      // XP/streak fields (may not exist until migration applied)
      streak_count?: number;
      longest_streak?: number;
      total_xp?: number;
      last_qod_date?: string | null;
    }
    ```
    Make these optional (?) since they may not exist in DB until a migration is applied. The existing `as unknown as StudentProfile` cast in `fetchStudentProfile` already handles this.
  </action>
  <verify>
    - `npx tsc --noEmit` passes with zero errors
    - `src/utils/levelSystem.ts` exists and exports `calculateLevelInfo`, `LEVEL_THRESHOLDS`
    - `src/utils/questionOfTheDayApi.ts` exists and exports `calculateStreak`, `getStreakData`, `updateStreakData`, `calculateXPReward`, `awardXP`
    - `src/hooks/useStudentProfile.ts` has `streak_count`, `total_xp`, `longest_streak`, `last_qod_date` in StudentProfile interface
  </verify>
  <done>Level system utility with 10 levels and XP thresholds exists. Streak/XP utility functions ported with mobile-compatible Supabase queries (user_id instead of profile id). StudentProfile interface includes XP/streak fields.</done>
</task>

<task type="auto">
  <name>Task 2: Enhance useQuestionOfTheDay hook with XP/streak side-effects</name>
  <files>
    src/hooks/useQuestionOfTheDay.ts
  </files>
  <action>
    Enhance the existing `useQuestionOfTheDay` hook to call streak/XP functions after saving a QOD answer. This matches the web app behavior.

    **Changes to `handleSubmitAnswer`:**
    After the existing QOD save logic (after `setHasAnsweredToday(true)` inside the `if (userId)` block), add streak/XP handling:

    ```typescript
    // After successful QOD save, update streak and award XP (fire-and-forget)
    try {
      const streakData = await getStreakData(userId);
      if (streakData) {
        const streakSignal = calculateStreak(streakData.last_qod_date, today);
        let newStreakCount: number;
        if (streakSignal === -1) {
          // Consecutive day -- increment
          newStreakCount = streakData.streak_count + 1;
        } else if (streakSignal === 0) {
          // Same day -- no change
          newStreakCount = streakData.streak_count;
        } else {
          // Missed day or first time -- use signal value (1)
          newStreakCount = streakSignal;
        }

        await updateStreakData(userId, newStreakCount, today);

        const xpAwards = calculateXPReward(correct, newStreakCount);
        let totalXpEarned = 0;
        for (const award of xpAwards) {
          await awardXP(userId, userId, award);
          totalXpEarned += award.amount;
        }

        setStreakCount(newStreakCount);
      }
    } catch (streakError) {
      console.error('Error updating streak/XP:', streakError);
      // Non-blocking: don't fail QOD submission
    }
    ```

    **Add imports at top of file:**
    ```typescript
    import { getStreakData, calculateStreak, updateStreakData, calculateXPReward, awardXP } from '../utils/questionOfTheDayApi';
    ```

    **Add new state and return values:**
    - Add `const [xpEarned, setXpEarned] = useState<number>(0);` state
    - Set `setXpEarned(totalXpEarned)` after XP awards
    - Add `xpEarned` to the return object
    - Add `totalXP` state: `const [totalXP, setTotalXP] = useState<number>(0);`
    - Set `setTotalXP((streakData.total_xp || 0) + totalXpEarned)` after XP awards
    - Add `totalXP` to the return object

    **Update initial streak load:**
    Replace the existing streak fetch in `initializeUser` (the try/catch block that reads streak_count from student_profiles) with a call to `getStreakData(user.id)`:
    ```typescript
    try {
      const streakData = await getStreakData(user.id);
      if (streakData) {
        setStreakCount(streakData.streak_count || 0);
        setTotalXP(streakData.total_xp || 0);
      }
    } catch (profileError) {
      console.log('Streak/XP data not available');
    }
    ```

    **Install confetti library while we're here:**
    Run: `cd /Users/robertisrael/Documents/GitHub/centsible-scholar-mobile && npx expo install react-native-confetti-cannon`
    This prepares for Plan 02 which needs it for the celebration screen.
  </action>
  <verify>
    - `npx tsc --noEmit` passes with zero errors
    - `useQuestionOfTheDay` hook imports from `../utils/questionOfTheDayApi`
    - Hook returns `xpEarned` and `totalXP` in addition to existing returns
    - `handleSubmitAnswer` function contains `getStreakData`, `calculateStreak`, `updateStreakData`, `calculateXPReward`, `awardXP` calls wrapped in try/catch
    - `react-native-confetti-cannon` appears in package.json dependencies
  </verify>
  <done>QOD hook now updates streaks and awards XP after every answer submission, matching web app behavior. Streak/XP failures are caught and logged without blocking the QOD save. Hook exposes xpEarned and totalXP for downstream UI consumption. Confetti library installed for Plan 02.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `src/utils/levelSystem.ts` exports match web app (calculateLevelInfo, LEVEL_THRESHOLDS, etc.)
- `src/utils/questionOfTheDayApi.ts` exports streak/XP functions with mobile-compatible user_id queries
- `src/hooks/useQuestionOfTheDay.ts` calls streak/XP functions in handleSubmitAnswer
- `src/hooks/useStudentProfile.ts` StudentProfile includes streak_count, total_xp, longest_streak, last_qod_date
- No regressions: existing QOD answer saving still works (streak/XP is additive, in try/catch)
</verification>

<success_criteria>
- XP level system utility exists with 10 levels and correct thresholds matching web app
- Streak calculation logic handles consecutive days, same day, missed days correctly
- QOD hook awards XP after every answer (10 base + 5 correct bonus + milestone bonuses)
- QOD hook updates streak after every answer
- All streak/XP operations are fire-and-forget (try/catch, non-blocking)
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-student-daily-experience/03-01-SUMMARY.md`
</output>
