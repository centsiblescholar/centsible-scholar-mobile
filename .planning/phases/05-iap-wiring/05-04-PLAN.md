---
phase: 05-iap-wiring
plan: 04
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - eas.json
  - app.json
autonomous: true

must_haves:
  truths:
    - "EAS development profile builds for both iOS simulator and physical device"
    - "EAS preview profile produces internal distribution builds for TestFlight/internal testing"
    - "EAS production profile produces App Store/Play Store release builds"
    - "react-native-purchases plugin is registered in app.json"
    - "New Architecture remains enabled for all build profiles"
  artifacts:
    - path: "eas.json"
      provides: "Build profiles for development (sim + device), preview, and production"
      contains: "development:device"
    - path: "app.json"
      provides: "react-native-purchases Expo config plugin registered"
      contains: "react-native-purchases"
  key_links:
    - from: "eas.json"
      to: "app.json"
      via: "EAS reads app.json for build configuration"
      pattern: "developmentClient"
    - from: "app.json"
      to: "react-native-purchases"
      via: "Expo config plugin for native module linking"
      pattern: "react-native-purchases"
---

<objective>
Configure EAS build profiles for development, preview, and production, and register the RevenueCat native module plugin in app.json so EAS builds include the StoreKit/Play Billing native code.

Purpose: Real IAP requires native builds (not Expo Go). Without proper EAS configuration, the app cannot make real purchases or be submitted to app stores.
Output: Updated eas.json with 4 build profiles, app.json with RevenueCat plugin.
</objective>

<execution_context>
@/Users/robertisrael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertisrael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-iap-wiring/05-CONTEXT.md
@.planning/phases/05-iap-wiring/05-RESEARCH.md
@eas.json
@app.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update EAS build profiles and app.json plugin configuration</name>
  <files>
    eas.json
    app.json
  </files>
  <action>
**Update `eas.json`:**

Keep the existing structure but add the `development:device` profile and ensure all profiles are correct for IAP:

```json
{
  "cli": {
    "version": ">= 16.0.0",
    "appVersionSource": "remote"
  },
  "build": {
    "development": {
      "developmentClient": true,
      "distribution": "internal",
      "ios": {
        "simulator": true
      }
    },
    "development:device": {
      "extends": "development",
      "distribution": "internal",
      "ios": {
        "simulator": false
      }
    },
    "preview": {
      "distribution": "internal",
      "ios": {
        "simulator": false
      },
      "android": {
        "buildType": "apk"
      }
    },
    "production": {
      "autoIncrement": true,
      "ios": {
        "resourceClass": "m-medium"
      },
      "android": {
        "buildType": "app-bundle"
      }
    }
  },
  "submit": {
    "production": {
      "ios": {
        "appleId": "rcisrael2@gmail.com",
        "ascAppId": "YOUR_APP_STORE_CONNECT_APP_ID",
        "appleTeamId": "YOUR_APPLE_TEAM_ID"
      },
      "android": {
        "serviceAccountKeyPath": "./google-service-account.json",
        "track": "internal"
      }
    }
  }
}
```

Key changes from existing:
- Added `development:device` profile that extends `development` but sets `simulator: false` for physical device testing (required for IAP sandbox testing)
- All existing profiles and submit configuration preserved exactly as-is

**Update `app.json`:**

Add `react-native-purchases` to the plugins array. This is required for EAS builds to include the native StoreKit and Google Play Billing modules.

In the `"plugins"` array, add `"react-native-purchases"` AFTER the existing plugins:

```json
"plugins": [
  "expo-router",
  [
    "expo-notifications",
    {
      "icon": "./assets/icon.png",
      "color": "#4F46E5",
      "sounds": []
    }
  ],
  "react-native-purchases"
]
```

Do NOT modify any other fields in app.json. The `newArchEnabled: true` is already correct and should remain.

**Build profile purposes (for reference, not in code):**
| Profile | Command | Purpose | IAP Testing |
|---------|---------|---------|-------------|
| development | `eas build --profile development` | Simulator dev builds | No (Expo Go mock mode) |
| development:device | `eas build --profile development:device` | Physical device dev builds | Yes (sandbox) |
| preview | `eas build --profile preview` | TestFlight/internal testing | Yes (sandbox) |
| production | `eas build --profile production` | App Store/Play Store release | Yes (real) |
  </action>
  <verify>
    - `eas.json` is valid JSON (run `node -e "JSON.parse(require('fs').readFileSync('eas.json','utf8'))"`)
    - `eas.json` contains `"development:device"` profile with `"simulator": false`
    - `eas.json` preserves all existing profiles and submit configuration
    - `app.json` is valid JSON
    - `app.json` plugins array contains `"react-native-purchases"`
    - `app.json` still has `"newArchEnabled": true`
    - `app.json` preserves all existing plugins (expo-router, expo-notifications)
  </verify>
  <done>
    EAS has 4 build profiles (development simulator, development device, preview, production). app.json registers the RevenueCat plugin for native module linking. New Architecture remains enabled.
  </done>
</task>

<task type="auto">
  <name>Task 2: Validate build configuration with EAS CLI</name>
  <files></files>
  <action>
Run the following validation commands to verify the build configuration is correct:

1. Validate the Expo config resolves correctly:
   ```
   npx expo config --type public
   ```
   Verify the output includes `react-native-purchases` in plugins and `newArchEnabled: true`.

2. Verify EAS can parse the build profiles:
   ```
   npx eas-cli build:list --limit 0
   ```
   This just validates EAS CLI can authenticate and read the project config. If it fails with auth error, that is expected and acceptable (user may not be logged in to EAS CLI).

3. Run a type check to ensure no regressions:
   ```
   npx tsc --noEmit
   ```

4. Run `npx expo prebuild --no-install --clean` (dry run of native project generation) to verify the config plugins resolve correctly. This generates ios/ and android/ directories temporarily. After verifying it succeeds, clean up:
   ```
   rm -rf ios/ android/
   ```
   If prebuild fails with plugin resolution errors, that indicates a configuration problem to fix.

Note: Do NOT actually trigger an EAS build (`eas build`). That requires cloud build credits and Apple/Google signing setup that may not be configured yet. Only validate the configuration locally.
  </action>
  <verify>
    - `npx expo config --type public` output shows `react-native-purchases` in plugins
    - `npx tsc --noEmit` passes
    - `npx expo prebuild --no-install --clean` succeeds (or fails only due to signing, not plugin resolution)
    - ios/ and android/ directories are cleaned up after validation
  </verify>
  <done>
    EAS build configuration is validated locally. Config plugins resolve correctly, TypeScript compiles, and the project is ready for actual EAS builds once signing and credentials are configured.
  </done>
</task>

</tasks>

<verification>
- `eas.json` has 4 build profiles: development, development:device, preview, production
- `app.json` includes `react-native-purchases` plugin
- New Architecture (`newArchEnabled: true`) is preserved
- All existing eas.json and app.json configuration is preserved
- Project type-checks and config resolves correctly
</verification>

<success_criteria>
- `development:device` profile exists for physical device IAP sandbox testing
- RevenueCat native plugin is registered so EAS builds include StoreKit/Play Billing
- Existing build profiles and submit configuration are unchanged
- Local config validation passes (expo config, tsc, prebuild)
- Project is ready for actual EAS builds pending signing credentials
</success_criteria>

<output>
After completion, create `.planning/phases/05-iap-wiring/05-04-SUMMARY.md`
</output>
