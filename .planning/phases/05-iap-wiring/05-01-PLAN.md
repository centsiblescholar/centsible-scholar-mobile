---
phase: 05-iap-wiring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/constants/revenuecatConfig.ts
  - src/constants/subscriptionPlans.ts
  - src/providers/RevenueCatProvider.tsx
  - app/_layout.tsx
autonomous: true
user_setup:
  - service: RevenueCat
    why: "IAP purchase flow requires RevenueCat project and API keys"
    env_vars:
      - name: REVENUECAT_IOS_API_KEY
        source: "RevenueCat Dashboard -> Project -> API Keys -> Public iOS API key (appl_...)"
      - name: REVENUECAT_ANDROID_API_KEY
        source: "RevenueCat Dashboard -> Project -> API Keys -> Public Android API key (goog_...)"
    dashboard_config:
      - task: "Create RevenueCat project linked to App Store Connect and Google Play Console"
        location: "RevenueCat Dashboard -> Projects -> New Project"
      - task: "Create products matching com.centsiblescholar.{tier}.{interval} convention (6 products)"
        location: "RevenueCat Dashboard -> Products"
      - task: "Create 'default' offering with 6 packages mapping to the 6 products"
        location: "RevenueCat Dashboard -> Offerings"
      - task: "Create 'premium' entitlement assigned to all 6 products"
        location: "RevenueCat Dashboard -> Entitlements"

must_haves:
  truths:
    - "RevenueCat SDK initializes once at app startup without errors"
    - "RevenueCat identifies the Supabase user ID when user is authenticated"
    - "RevenueCat logs out when user signs out"
    - "Subscription plan constants include Apple and Google product IDs"
  artifacts:
    - path: "src/constants/revenuecatConfig.ts"
      provides: "RevenueCat API keys, entitlement ID, polling config"
      contains: "REVENUECAT_CONFIG"
    - path: "src/constants/subscriptionPlans.ts"
      provides: "Product ID fields on existing plan constants"
      contains: "appleProductId"
    - path: "src/providers/RevenueCatProvider.tsx"
      provides: "SDK initialization, user identification, logout on sign-out"
      exports: ["RevenueCatProvider"]
    - path: "app/_layout.tsx"
      provides: "RevenueCatProvider wrapping app tree"
      contains: "RevenueCatProvider"
  key_links:
    - from: "src/providers/RevenueCatProvider.tsx"
      to: "src/constants/revenuecatConfig.ts"
      via: "import getRevenueCatApiKey"
      pattern: "getRevenueCatApiKey"
    - from: "src/providers/RevenueCatProvider.tsx"
      to: "src/contexts/AuthContext.tsx"
      via: "useAuth for user identification"
      pattern: "useAuth.*user"
    - from: "app/_layout.tsx"
      to: "src/providers/RevenueCatProvider.tsx"
      via: "wraps children in provider tree"
      pattern: "<RevenueCatProvider>"
---

<objective>
Install RevenueCat SDK, create configuration constants with product ID mappings, build the RevenueCat provider component, and wire it into the app layout.

Purpose: This is the foundation for all IAP work. The SDK must be initialized and user identification must work before purchases or webhooks can function.
Output: RevenueCat SDK installed, config constants created, provider wired into app tree, subscription plans updated with product IDs.
</objective>

<execution_context>
@/Users/robertisrael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertisrael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-iap-wiring/05-CONTEXT.md
@.planning/phases/05-iap-wiring/05-RESEARCH.md
@src/constants/subscriptionPlans.ts
@src/contexts/AuthContext.tsx
@app/_layout.tsx
@app.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install RevenueCat SDK and create configuration constants</name>
  <files>
    src/constants/revenuecatConfig.ts
    src/constants/subscriptionPlans.ts
  </files>
  <action>
1. Install dependencies:
   ```
   npx expo install react-native-purchases expo-dev-client
   ```

2. Create `src/constants/revenuecatConfig.ts` with:
   - `REVENUECAT_CONFIG` object containing:
     - `apiKeys.ios`: `'appl_REPLACE_WITH_REAL_KEY'` (placeholder for user to fill)
     - `apiKeys.android`: `'goog_REPLACE_WITH_REAL_KEY'` (placeholder for user to fill)
     - `entitlementId`: `'premium'`
     - `polling.intervalMs`: `2000` (2 seconds between polls)
     - `polling.timeoutMs`: `60000` (60 seconds total timeout)
   - Export `getRevenueCatApiKey()` function that returns the correct key based on `Platform.OS`
   - Type the config object with `as const`

3. Update `src/constants/subscriptionPlans.ts`:
   - Add to the `SubscriptionPlan` interface:
     - `appleProductId: { monthly: string; annual: string }`
     - `googleProductId: { monthly: string; annual: string }`
     - `rcPackageId: { monthly: string; annual: string }`
   - Add product IDs to each plan in `SUBSCRIPTION_PLANS` using the convention:
     - Apple/Google: `com.centsiblescholar.{tier}.monthly` and `com.centsiblescholar.{tier}.annual`
     - RC package: `$rc_monthly` and `$rc_annual` (RevenueCat standard package identifiers)
   - Add a helper function `getProductIdForPlatform(planId, billingInterval, platform)` that returns the correct product ID string

Do NOT modify any existing function signatures or exports. Only add new fields and functions.
  </action>
  <verify>
    - `npx tsc --noEmit` passes without errors
    - `src/constants/revenuecatConfig.ts` exists and exports `REVENUECAT_CONFIG` and `getRevenueCatApiKey`
    - `src/constants/subscriptionPlans.ts` has `appleProductId` field on all 3 plans
    - `react-native-purchases` appears in package.json dependencies
  </verify>
  <done>
    RevenueCat SDK is installed, config constants define API key placeholders and polling settings, subscription plans include platform-specific product IDs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create RevenueCatProvider and wire into app layout</name>
  <files>
    src/providers/RevenueCatProvider.tsx
    app/_layout.tsx
  </files>
  <action>
1. Create `src/providers/RevenueCatProvider.tsx`:
   - Import `Purchases, LOG_LEVEL` from `react-native-purchases`
   - Import `getRevenueCatApiKey` from `../constants/revenuecatConfig`
   - Import `useAuth` from `../contexts/AuthContext`
   - Use a `useRef(false)` to track if SDK is already configured (prevent double-configure)
   - First `useEffect` (no deps, runs once):
     - If already configured, return early
     - If `__DEV__`, set `Purchases.setLogLevel(LOG_LEVEL.VERBOSE)`
     - Call `Purchases.configure({ apiKey: getRevenueCatApiKey() })`
     - Mark ref as configured
   - Second `useEffect` (depends on `user?.id`):
     - If not configured, return early
     - If `user` exists, call `Purchases.logIn(user.id)` -- this links RevenueCat customer to Supabase user ID
     - If `user` is null (signed out), call `Purchases.logOut()` -- resets to anonymous
     - Wrap both in try/catch with console.warn (non-fatal -- SDK errors shouldn't crash the app)
   - Render `<>{children}</>` (no additional UI)

2. Update `app/_layout.tsx`:
   - Import `RevenueCatProvider` from `../src/providers/RevenueCatProvider`
   - Wrap the existing tree: place `<RevenueCatProvider>` INSIDE `<AuthProvider>` (needs auth context) but OUTSIDE `<StudentProvider>` and `<Stack>`
   - The provider tree should be: `QueryClientProvider > AuthProvider > RevenueCatProvider > StudentProvider > Stack`

Do NOT use `appUserID` in `Purchases.configure()`. User identification happens via `Purchases.logIn()` after auth is available. This handles the case where the user is not authenticated when the app starts.

Do NOT call `Purchases.getCustomerInfo()` or check entitlements in the provider. Supabase is the source of truth for subscription status (per CONTEXT.md).
  </action>
  <verify>
    - `npx tsc --noEmit` passes without errors
    - `app/_layout.tsx` contains `RevenueCatProvider` in the component tree
    - `src/providers/RevenueCatProvider.tsx` imports from `react-native-purchases`
    - Provider calls `Purchases.configure()` exactly once and `Purchases.logIn()` on user change
  </verify>
  <done>
    RevenueCat SDK initializes at app startup, identifies the authenticated user's Supabase ID, and logs out on sign-out. Provider is wired into the app tree inside AuthProvider.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` compiles the project without type errors
- `react-native-purchases` and `expo-dev-client` are in package.json
- RevenueCatProvider is in the _layout.tsx provider chain
- subscriptionPlans.ts has product ID fields on all plans
- revenuecatConfig.ts has API key placeholders and polling config
</verification>

<success_criteria>
- RevenueCat SDK is installed and the provider initializes it once at startup
- User identification links Supabase user ID to RevenueCat customer on login and resets on logout
- All 3 subscription plans have Apple, Google, and RevenueCat package identifiers
- Configuration constants centralize API keys, entitlement IDs, and polling settings
- The app still compiles and type-checks without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-iap-wiring/05-01-SUMMARY.md`
</output>
