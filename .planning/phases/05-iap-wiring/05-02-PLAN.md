---
phase: 05-iap-wiring
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/revenuecat-webhook/index.ts
  - supabase/config.toml
autonomous: true
user_setup:
  - service: Supabase Edge Function
    why: "Webhook must be deployed to shared Supabase project and secrets configured"
    env_vars:
      - name: REVENUECAT_WEBHOOK_AUTH_KEY
        source: "Generate a secure random string (e.g., openssl rand -hex 32), then set it in both RevenueCat dashboard and Supabase secrets"
    dashboard_config:
      - task: "Deploy edge function: supabase functions deploy revenuecat-webhook"
        location: "CLI from project root"
      - task: "Set webhook secret: supabase secrets set REVENUECAT_WEBHOOK_AUTH_KEY=your_key"
        location: "CLI"
      - task: "Configure webhook URL in RevenueCat dashboard"
        location: "RevenueCat Dashboard -> Project -> Integrations -> Webhooks -> Add Endpoint: https://YOUR_PROJECT_REF.supabase.co/functions/v1/revenuecat-webhook"
      - task: "Set Authorization header in RevenueCat webhook config to: Bearer your_key"
        location: "RevenueCat Dashboard -> Webhooks -> Authorization Header"

must_haves:
  truths:
    - "RevenueCat INITIAL_PURCHASE event creates or updates a user_subscriptions row with status active or trialing"
    - "RevenueCat RENEWAL event updates the subscription period dates"
    - "RevenueCat CANCELLATION event sets status to canceled"
    - "RevenueCat EXPIRATION event sets status to expired"
    - "RevenueCat BILLING_ISSUE event sets status to past_due"
    - "Duplicate webhook events are processed only once via webhook_events idempotency table"
    - "Webhook returns HTTP 200 even for processing errors to prevent RevenueCat retry storms"
  artifacts:
    - path: "supabase/functions/revenuecat-webhook/index.ts"
      provides: "Webhook handler processing RevenueCat subscription lifecycle events"
      min_lines: 150
    - path: "supabase/config.toml"
      provides: "JWT verification disabled for webhook endpoint"
      contains: "verify_jwt = false"
  key_links:
    - from: "supabase/functions/revenuecat-webhook/index.ts"
      to: "user_subscriptions table"
      via: "supabaseAdmin.from('user_subscriptions')"
      pattern: "user_subscriptions"
    - from: "supabase/functions/revenuecat-webhook/index.ts"
      to: "webhook_events table"
      via: "idempotency check and record"
      pattern: "webhook_events"
---

<objective>
Create a Supabase Edge Function that receives RevenueCat webhook events and syncs subscription state to the `user_subscriptions` table, mirroring the existing `stripe-webhook` patterns for idempotency, error handling, and subscription updates.

Purpose: This is the server-side bridge between RevenueCat and Supabase. Without it, purchases made through Apple/Google never update the app's subscription records.
Output: A deployable Supabase Edge Function and config to disable JWT verification for the webhook endpoint.
</objective>

<execution_context>
@/Users/robertisrael/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertisrael/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-iap-wiring/05-CONTEXT.md
@.planning/phases/05-iap-wiring/05-RESEARCH.md

Reference the web app's stripe webhook for patterns:
@/Users/robertisrael/Documents/GitHub/centsible-scholar-premium/supabase/functions/stripe-webhook/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RevenueCat webhook edge function</name>
  <files>
    supabase/functions/revenuecat-webhook/index.ts
  </files>
  <action>
Create the directory `supabase/functions/revenuecat-webhook/` and the `index.ts` file.

Mirror the stripe-webhook patterns from the web app (`/Users/robertisrael/Documents/GitHub/centsible-scholar-premium/supabase/functions/stripe-webhook/index.ts`). Specifically port these patterns:

1. **Structured logging** with `[REVENUECAT-WEBHOOK]` prefix (mirrors `[STRIPE-WEBHOOK]` pattern)

2. **Authorization verification**: Check `Authorization` header matches `Bearer ${REVENUECAT_WEBHOOK_AUTH_KEY}` from `Deno.env.get()`. Return 401 if mismatch.

3. **Supabase admin client**: Initialize with `SUPABASE_URL` and `SUPABASE_SERVICE_ROLE_KEY` env vars, `persistSession: false`.

4. **Idempotency check** (exact same pattern as stripe-webhook):
   - Extract `event.id` from the payload
   - Query `webhook_events` table for existing `event_id`
   - If found, return `{ received: true, already_processed: true }` with 200
   - After successful processing, insert into `webhook_events` with `event_id`, `event_type`, `processing_time_ms`

5. **Event processing** by `event.type` (from RevenueCat webhook payload structure):
   - `INITIAL_PURCHASE`, `RENEWAL`, `UNCANCELLATION` -> `handleSubscriptionActive()`
   - `CANCELLATION` -> `handleCancellation()`
   - `EXPIRATION` -> `handleExpiration()`
   - `BILLING_ISSUE` -> `handleBillingIssue()`
   - `PRODUCT_CHANGE` -> `handleProductChange()`
   - `TEST` -> Log only, no database action
   - Default -> Log unknown event type, no database action

6. **handleSubscriptionActive()**: Two-step query-then-upsert (same pattern as stripe-webhook `handleSubscriptionUpdate`):
   - Extract `app_user_id` as `userId` (this is the Supabase user UUID set via `Purchases.logIn()`)
   - Map `product_id` to `subscription_type` using a mapping object:
     - `com.centsiblescholar.single.monthly` and `com.centsiblescholar.single.annual` -> `'single'`
     - `com.centsiblescholar.midsize.monthly` and `com.centsiblescholar.midsize.annual` -> `'midsize'`
     - `com.centsiblescholar.large.monthly` and `com.centsiblescholar.large.annual` -> `'large'`
   - Map `store` field: `'APP_STORE'` -> `'apple'`, `'PLAY_STORE'` -> `'google'`
   - Determine status: if `period_type === 'TRIAL'` then `'trialing'`, else `'active'`
   - Build subscription data object with: `user_id`, `status`, `subscription_type`, `platform`, `iap_product_id` (from `product_id`), `iap_original_transaction_id` (from `original_transaction_id`), `revenucat_customer_id` (from `app_user_id`), `current_period_start` (from `purchased_at_ms`, convert ms to ISO string), `current_period_end` (from `expiration_at_ms`, convert ms to ISO string), `updated_at`
   - Query existing: `supabaseAdmin.from('user_subscriptions').select('id').eq('user_id', userId).maybeSingle()`
   - If existing: `.update(subscriptionData).eq('user_id', userId)`
   - If not existing: `.insert(subscriptionData)`
   - Log the action taken

7. **handleCancellation()**: Update status to `'canceled'`, set `canceled_at` to now, filter by `user_id` AND `platform IN ('apple', 'google')` (do not touch Stripe subscriptions).

8. **handleExpiration()**: Update status to `'expired'`, filter same as cancellation.

9. **handleBillingIssue()**: Update status to `'past_due'`, filter same as cancellation.

10. **handleProductChange()**: Same as handleSubscriptionActive (re-maps product to subscription_type). This handles upgrades/downgrades.

11. **Error handling**: Wrap all processing in try/catch. On error, log with structured logging, return HTTP 200 with `{ error: message }`. This mirrors the Stripe webhook pattern (stripe-webhook line 622-628) which returns 200 on errors to prevent retry storms and duplicate processing.

12. **Payload structure**: RevenueCat sends the event nested as `payload.event`. Key fields on the event object:
    - `event.id` - unique event ID for idempotency
    - `event.type` - event type string (e.g., 'INITIAL_PURCHASE')
    - `event.app_user_id` - the Supabase user UUID
    - `event.product_id` - store product identifier
    - `event.original_transaction_id` - original transaction ID from store
    - `event.store` - 'APP_STORE' or 'PLAY_STORE'
    - `event.period_type` - 'TRIAL' or 'NORMAL'
    - `event.purchased_at_ms` - purchase timestamp in milliseconds
    - `event.expiration_at_ms` - expiration timestamp in milliseconds
    - `event.environment` - 'SANDBOX' or 'PRODUCTION'

Use Deno imports matching the stripe-webhook versions:
```
import { serve } from 'https://deno.land/std@0.190.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.45.0'
```
  </action>
  <verify>
    - File exists at `supabase/functions/revenuecat-webhook/index.ts`
    - File contains `serve(async` handler
    - File contains idempotency check against `webhook_events` table
    - File handles all 6 event types (INITIAL_PURCHASE, RENEWAL, CANCELLATION, EXPIRATION, BILLING_ISSUE, UNCANCELLATION)
    - File always returns HTTP 200 (check there are no non-200 returns after the auth check)
    - Two-step query-then-upsert pattern is used (not `.upsert()`)
  </verify>
  <done>
    RevenueCat webhook handler exists with idempotent processing for all subscription lifecycle events, mirroring the stripe-webhook patterns. It maps RevenueCat events to user_subscriptions updates and always returns 200 to prevent retry storms.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Supabase config to disable JWT for webhook endpoint</name>
  <files>
    supabase/config.toml
  </files>
  <action>
Create `supabase/config.toml` at the project root's `supabase/` directory.

Content:
```toml
# Supabase Edge Function Configuration
# Disable JWT verification for webhook endpoints that receive external calls.
# These endpoints implement their own authorization (Bearer token verification).

[functions.revenuecat-webhook]
verify_jwt = false
```

This is required because:
- Supabase Edge Functions require a valid Supabase JWT by default
- RevenueCat sends its own Bearer token, not a Supabase JWT
- Without this config, all webhook calls would be rejected with 401
- The edge function implements its own auth check (Bearer token comparison)

Note: If a `supabase/config.toml` already exists, MERGE this content into it rather than overwriting. Check first.
  </action>
  <verify>
    - `supabase/config.toml` exists
    - Contains `[functions.revenuecat-webhook]` section
    - Contains `verify_jwt = false`
  </verify>
  <done>
    Supabase config disables JWT verification for the revenuecat-webhook endpoint, allowing RevenueCat to call it with its own Bearer token authorization.
  </done>
</task>

</tasks>

<verification>
- `supabase/functions/revenuecat-webhook/index.ts` exists and is syntactically valid Deno TypeScript
- `supabase/config.toml` disables JWT for the webhook endpoint
- The webhook handler mirrors stripe-webhook patterns: structured logging, idempotency via webhook_events, two-step query-then-upsert, always returns 200
- All RevenueCat subscription lifecycle events are handled (INITIAL_PURCHASE, RENEWAL, CANCELLATION, EXPIRATION, BILLING_ISSUE, UNCANCELLATION, PRODUCT_CHANGE, TEST)
</verification>

<success_criteria>
- Webhook handler processes RevenueCat events and updates user_subscriptions with correct status, platform, product ID, and transaction ID
- Idempotent: duplicate events are detected and skipped via webhook_events table
- Always returns HTTP 200 to prevent RevenueCat retry storms
- Maps RevenueCat product IDs to subscription types (single/midsize/large)
- Maps store names to platform values (apple/google)
- Handles trial vs normal period types
- JWT verification disabled for the webhook endpoint
</success_criteria>

<output>
After completion, create `.planning/phases/05-iap-wiring/05-02-SUMMARY.md`
</output>
